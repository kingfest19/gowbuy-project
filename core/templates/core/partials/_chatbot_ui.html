{% load static i18n %}

<style>
    #nexusChatbotContainer {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050; /* Ensure it's above most other content */
    }

    #nexusChatbotToggleButton {
        background-color: var(--bs-dark, #212529); /* Match your site's dark theme */
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 28px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
     #nexusChatbotToggleButton:hover {
        background-color: var(--bs-primary, #0d6efd); /* Use your site's primary blue for hover */
     }


    #nexusChatWindow {
        display: none; /* Hidden by default */
        position: fixed;
        bottom: 90px; /* Above the toggle button */
        right: 20px;
        width: 370px; /* Slightly wider */
        max-width: 95vw;
        height: 450px;
        max-height: 70vh;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .nexus-chat-header {
        background-color: var(--bs-dark, #212529); /* Dark header */
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .nexus-chat-header h5 {
        color: white;
        margin-bottom: 0;
        font-size: 1.1rem;
    }
    .nexus-chat-header .btn-close-chat {
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
    }

    .nexus-chat-messages {
        flex-grow: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .nexus-chat-message {
        padding: 8px 12px;
        border-radius: 15px;
        max-width: 80%;
        word-wrap: break-word;
    }

    .nexus-chat-message.user {
        background-color: var(--bs-primary, #0d6efd); /* Primary blue for user messages */
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 5px;
    }

    .nexus-chat-message.ai {
        background-color: #e9ecef;
        color: #333;
        align-self: flex-start;
        border-bottom-left-radius: 5px;
    }
     .nexus-chat-message.error {
        background-color: var(--bs-danger-bg-subtle, #f8d7da);
        color: var(--bs-danger-text-emphasis, #721c24);
        border: 1px solid var(--bs-danger-border-subtle, #f5c6cb);
        align-self: flex-start;
     }
    .nexus-chat-item-card {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        display: flex;
        flex-direction: column; /* Stack content vertically */
        gap: 10px;
        text-decoration: none;
        color: inherit;
        transition: box-shadow 0.2s ease-in-out;
        margin-top: 5px; /* Space between text and cards */
    }
    .nexus-chat-item-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        color: inherit;
    }
    .nexus-chat-item-card-header {
        display: flex;
        gap: 10px;
        align-items: center;
        width: 100%;
    }
    .nexus-chat-item-card-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        width: 100%;
    }
    .nexus-chat-item-card-actions .btn {
        flex-grow: 1;
    }
    .nexus-chat-item-card img {
        width: 60px;
        height: 60px;
        border-radius: 4px;
        object-fit: cover;
    }
    .nexus-chat-product-card-info h6 { margin-bottom: 2px; font-size: 0.9rem; }
    .nexus-chat-product-card-info p { margin-bottom: 0; font-size: 0.8rem; color: #6c757d; }


    .nexus-chat-input-area {
        padding: 10px;
        border-top: 1px solid #dee2e6;
        display: flex;
    }

    .nexus-chat-input-area input[type="text"] {
        flex-grow: 1;
        border: 1px solid #ced4da;
        border-radius: 20px;
        padding: 8px 15px;
        margin-right: 8px;
        font-size: 0.9rem;
    }
    .nexus-chat-input-area input[type="text"]:focus {
        outline: none;
        border-color: var(--bs-primary, #0d6efd);
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .nexus-chat-input-area button {
        background-color: var(--bs-primary, #0d6efd);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .nexus-chat-input-area button:hover {
        background-color: var(--bs-dark, #212529);
    }
    .nexus-chat-input-area button:disabled {
        background-color: #adb5bd;
        cursor: not-allowed;
    }
    .typing-indicator span {
        height: 8px;
        width: 8px;
        background-color: #adb5bd;
        border-radius: 50%;
        display: inline-block;
        margin: 0 2px;
        animation: bounce 1.4s infinite ease-in-out both;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1.0); }
    }

</style>

<div id="nexusChatbotContainer">
    <button id="nexusChatbotToggleButton" aria-label="{% trans 'Open Chat' %}" aria-expanded="false">
        <i class="bi bi-chat-dots-fill"></i> <!-- Bootstrap Icon -->
    </button>

    <div id="nexusChatWindow">
        <div class="nexus-chat-header">
            <h5>{% trans "NEXUS Chat" %}</h5>
            <button class="btn-close-chat" id="nexusChatCloseButton" aria-label="{% trans 'Close Chat' %}">&times;</button>
        </div>
        <div class="nexus-chat-messages" id="nexusChatMessages" role="log" aria-live="polite" aria-atomic="false">
            <!-- Chat messages will appear here, aria-live will announce new messages -->
            <div class="nexus-chat-message ai">{% trans "Hello! How can I help you shop today?" %}</div>
        </div>
        <div class="nexus-chat-input-area">
            <input type="text" id="nexusChatMessageInput" placeholder="{% trans 'Type your message...' %}" aria-label="{% trans 'Chat message input' %}">
            <button id="nexusChatSendButton" aria-label="{% trans 'Send Message' %}">
                <i class="bi bi-send-fill"></i>
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const toggleButton = document.getElementById('nexusChatbotToggleButton');
    const chatWindow = document.getElementById('nexusChatWindow');
    const closeButton = document.getElementById('nexusChatCloseButton');
    const messagesContainer = document.getElementById('nexusChatMessages');
    const messageInput = document.getElementById('nexusChatMessageInput');
    const sendButton = document.getElementById('nexusChatSendButton');

    let conversationHistory = []; // Store conversation history

    // Function to toggle chat window visibility
    function toggleChatWindow() {
        const isOpen = chatWindow.style.display === 'flex';
        chatWindow.style.display = isOpen ? 'none' : 'flex';
        toggleButton.setAttribute('aria-expanded', String(!isOpen)); // Update aria-expanded
        toggleButton.innerHTML = isOpen ? '<i class="bi bi-chat-dots-fill"></i>' : '<i class="bi bi-x-lg"></i>';
        if (!isOpen) {
            messageInput.focus(); // Manage focus when opening
        }
    }

    toggleButton.addEventListener('click', () => {
        toggleChatWindow();
        // Optionally, announce chat window state if not handled by aria-expanded alone
    });
    closeButton.addEventListener('click', toggleChatWindow);

    // Function to add a message to the chat display
    function addMessageToDisplay(text, type) { // type can be 'user', 'ai', or 'error'
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('nexus-chat-message', type);
        messageDiv.innerHTML = text; // Use innerHTML to render potential links
        // For screen readers, new messages in an aria-live region are usually announced.
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to bottom
    }

    // Function to add item (product/service) cards to the chat display
    function addItemCardsToDisplay(items) {
        items.forEach(item => {
            const itemCard = document.createElement('div');
            itemCard.classList.add('nexus-chat-item-card');
            
            // Determine if it's a product or service for the "Add to Cart" URL
            const addToCartUrl = item.type === 'product' ? `{% url 'core:add_to_cart' 0 %}`.replace('0', item.id) : '#'; // Placeholder for service
            const addToCartDisabled = item.type !== 'product' ? 'disabled' : '';
            const addToCartTitle = item.type !== 'product' ? `{% trans "Booking services from chat is coming soon" %}` : `{% trans "Add to Cart" %}`;

            itemCard.innerHTML = `
                <div class="nexus-chat-item-card-header">
                    <img src="${item.image_url}" alt="${item.name}">
                    <div class="nexus-chat-item-card-info">
                        <h6>${item.name}</h6>
                        <p>GHâ‚µ ${item.price}</p>
                    </div>
                </div>
                <div class="nexus-chat-item-card-actions">
                    <a href="${item.url}" target="_blank" class="btn btn-sm btn-outline-secondary">{% trans "View Details" %}</a>
                    <a href="${addToCartUrl}" class="btn btn-sm btn-primary" ${addToCartDisabled} title="${addToCartTitle}">
                        <i class="bi bi-cart-plus"></i> {% trans "Add to Cart" %}
                    </a>
                </div>
            `;

            // Add event listener for the "Add to Cart" button if it's a product
            if (item.type === 'product') {
                const addToCartBtn = itemCard.querySelector('.btn-primary');
                addToCartBtn.addEventListener('click', function(e) {
                    e.preventDefault(); // Prevent default link behavior
                    // You can add an AJAX call here to add to cart without a page reload
                    // For now, we'll just show a confirmation and let the link work
                    addMessageToDisplay(`{% trans "Adding" %} '${item.name}' {% trans "to your cart..." %}`, 'ai');
                    // Redirect to the add_to_cart URL
                    window.location.href = this.href;
                });
            }

            messagesContainer.appendChild(itemCard);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.classList.add('nexus-chat-message', 'ai', 'typing-indicator');
        typingDiv.innerHTML = '<span></span><span></span><span></span>';
        typingDiv.setAttribute('aria-label', '{% trans "AI is typing" %}'); // Announce typing
        messagesContainer.appendChild(typingDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        return typingDiv;
    }

    function removeTypingIndicator(indicatorElement) {
        if (indicatorElement && indicatorElement.parentNode === messagesContainer) {
            messagesContainer.removeChild(indicatorElement);
        }
    }


    // Function to send message to backend
    async function sendMessage() {
        const userMessage = messageInput.value.trim();
        if (!userMessage) return;

        // Add to conversation history
        conversationHistory.push(`User: ${userMessage}`);
        if (conversationHistory.length > 6) conversationHistory.shift(); // Keep history short

        addMessageToDisplay(userMessage, 'user');
        messageInput.value = '';
        sendButton.disabled = true;
        
        const typingIndicator = showTypingIndicator();

        try {
            // Step 1: Get AI response and item IDs
            const response = await fetch("{% url 'core:ajax_chatbot_message' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}' // Make sure CSRF token is available
                },
                body: JSON.stringify({ 
                    message: userMessage,
                    history: conversationHistory.join('\n')
                })
            });

            removeTypingIndicator(typingIndicator);

            if (!response.ok) {
                let errorMsg = `{% trans "An unexpected error occurred. Status:" %} ${response.status}`;
                try {
                    const errData = await response.json();
                    // Use the specific error from backend if available
                    errorMsg = errData.error || `{% trans "Error from server:" %} ${errData.detail || JSON.stringify(errData)}`;
                } catch (e) { /* Ignore if response not JSON, use the status-based message */ }
                addMessageToDisplay(errorMsg, 'error');
                // Log the more detailed error to the console for debugging
                console.error('Chatbot backend error:', response.status, await response.text().catch(() => 'Could not read error response body'));
                sendButton.disabled = false;
                return;
            }

            const data = await response.json();

            // Handle cases where the backend returns a JSON object with an error key,
            // even with a 200 OK status. This is common for application-level errors.
            if (data.error) {
                addMessageToDisplay(data.error, 'error');
                sendButton.disabled = false;
                return;
            }

            // Display the AI's text response
            if (data.response_text) {
                addMessageToDisplay(data.response_text, 'ai');
                conversationHistory.push(`AI: ${data.response_text}`);
                if (conversationHistory.length > 6) conversationHistory.shift();
            }
            // If we have item IDs, fetch their details and display them
            const hasProducts = data.product_ids && data.product_ids.length > 0;
            const hasServices = data.service_ids && data.service_ids.length > 0;

            if (hasProducts || hasServices) {
                const itemDetailsResponse = await fetch("{% url 'core:ajax_get_item_details' %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ product_ids: data.product_ids || [], service_ids: data.service_ids || [] })
                });
                const itemDetailsData = await itemDetailsResponse.json();
                if (itemDetailsData.items && itemDetailsData.items.length > 0) {
                    addItemCardsToDisplay(itemDetailsData.items);
                }
            }

            sendButton.disabled = false;

        } catch (error) {
            removeTypingIndicator(typingIndicator);
            sendButton.disabled = false;
            console.error('Chatbot fetch/network error:', error);
            const networkErrorMsg = "{% trans 'Network error or AI assistant is unavailable. Please try again.' %}";
            addMessageToDisplay(networkErrorMsg, 'error');
        }
        messageInput.focus();
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
});
</script>
