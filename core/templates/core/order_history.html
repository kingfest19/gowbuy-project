{% extends 'base.html' %}
{% load static %}
{% load humanize %} {# Keep this for intcomma and floatformat #}

{% block title %} Your Orders{% endblock title %}

{% block extra_css %}
    {# --- Link the RENAMED CSS file --- #}
    <link rel="stylesheet" href="{% static 'assets/css/order_history.css' %}" />
{% endblock extra_css %}

{% block content %}
<div class="container my-4">
  <!-- Add margin top/bottom -->

  <h1 class="mb-4 section-title">Your Orders</h1>

  <div class="order-list">
    {# --- Assuming 'orders' is passed from the view --- #}
    {% if orders %}
        {% for order in orders %}
            <div class="card order-card mb-4 shadow-sm">
                <div class="card-header order-header d-flex flex-wrap justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">ORDER PLACED</small><br />
                        {{ order.created_at|date:"M d, Y" }} {# Standard date format #}
                    </div>
                    <div>
                        <small class="text-muted">TOTAL</small><br />
                        ${{ order.total_amount|floatformat:2|intcomma }} {# Format currency #}
                    </div>
                    <div>
                        <small class="text-muted">ORDER #</small><br />
                        {# --- CORRECTED: Use order.order_id --- #}
                        {{ order.order_id }}
                        {# --- END CORRECTION --- #}
                    </div>
                    <div class="order-status status-{{ order.status|lower|slugify }}"> {# Class for potential CSS styling #}
                        <small class="text-muted">STATUS</small><br />
                        {{ order.get_status_display|default:order.status }} {# Display friendly status name #}
                    </div>
                     {# --- ADDED: Payment Status --- #}
                    <div class="order-payment-status status-{{ order.payment_status|lower|slugify }}">
                        <small class="text-muted">PAYMENT</small><br />
                         <span class="badge bg-{% if order.payment_status == 'paid' %}success{% elif order.payment_status == 'failed' %}danger{% else %}warning text-dark{% endif %}">{{ order.get_payment_status_display }}</span>
                    </div>
                     {# --- END ADDED: Payment Status --- #}
                    <div class="order-header-actions">
                        {# --- CORRECTED: Use get_absolute_url --- #}
                        <a href="{{ order.get_absolute_url }}" class="btn btn-sm btn-outline-primary">View Details</a>
                        {# --- END CORRECTION --- #}
                    </div>
                </div>

                <div class="card-body order-body">
                    {# --- Loop through items related to the order --- #}
                    {% for item in order.items.all %}
                        <div class="order-item d-flex align-items-center mb-3 {% if not forloop.last %}pb-3 border-bottom{% endif %}">
                            <div class="item-image me-3">
                                {# --- ADDED: Check if item.product and item.product.image exist --- #}
                                {% if item.product and item.product.image %}
                                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" width="80" />
                                {% elif item.product %} {# Product exists but no image #}
                                     <img src="{% static 'assets/img/placeholder.png' %}" alt="Placeholder" width="80" />
                                {% else %} {# Product was deleted #}
                                    <img src="{% static 'assets/img/placeholder.png' %}" alt="Placeholder" width="80" />
                                {% endif %}
                                {# --- END ADDED CHECK --- #}
                            </div>
                            <div class="item-details flex-grow-1">
                                {# --- ADDED: Check if item.product exists before accessing name --- #}
                                <h6 class="mb-1">{{ item.product.name|default:item.product_name|default:"[Product Unavailable]" }}</h6>
                                {# --- END ADDED CHECK --- #}
                                <small class="text-muted">Qty: {{ item.quantity }}</small><br />
                                <small class="text-muted">Price: ${{ item.price|floatformat:2|intcomma }}</small> {# Format item price #}
                            </div>
                            <div class="item-actions ms-3 text-end">
                                {# Placeholder for actions like "Buy Again", "Write Review" #}
                                {# <a href="#" class="btn btn-sm btn-outline-secondary">Buy Again</a> #}
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-muted">No items found for this order.</p>
                    {% endfor %}
                </div>

                {# Removed Return Items section from card footer #}
            </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info text-center" role="alert">
            You haven't placed any orders yet.
            {# --- CORRECTED: Use namespaced home URL --- #}
            <a href="{% url 'core:home' %}" class="alert-link">Start shopping!</a>
            {# --- END CORRECTION --- #}
        </div>
    {% endif %}
  </div>

  {# --- START: Added Back Return Policy Section --- #}
  <hr class="my-5" />
  <div class="return-policy-info text-center p-4 bg-light rounded">
    <h3 class="mb-3">Return Policy</h3>
    <p class="text-muted">
      Need to return an item? Please review our
      {# Link to terms page (or create a dedicated return policy page later) #}
      <a href="{% url 'terms' %}">full return policy</a>
      for details on eligibility, timelines, and procedures.
    </p>
    <p class="text-muted">
      Most items can be returned within 30 days of delivery. Some exclusions apply.
    </p>
    {# Link to help page #}
    <a href="{% url 'help' %}" class="btn btn-secondary mt-2">Contact Support</a>
  </div>
  {# --- END: Added Back Return Policy Section --- #}

</div> {# End container #}
{% endblock content %}

{% block extra_js %}
    {{ block.super }} {# <<< ADD THIS LINE #}
{% endblock extra_js %}
