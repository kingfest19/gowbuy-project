{% extends 'base.html' %} {# <<< EXTEND THE BASE TEMPLATE #}
{% load static %}
{% load humanize %} {# <<< LOAD HUMANIZED FOR CURRENCY FORMATTING #}

{% block title %}Shopping Cart - NEXUS{% endblock title %}

{% block extra_css %}
    {# Link cart-specific CSS #}
    <link rel="stylesheet" href="{% static 'assets/css/cart.css' %}" />
    {# Add specific cart styles below or keep in cart.css #}
    <style>
      /* Basic Cart Layout Styles (Add more specific styles to cart.css) */
      .cart-page-container {
        max-width: 1200px;
        margin: 2rem auto; /* Add margin */
        padding: 0 1rem; /* Add padding */
      }

      .cart-main {
        display: flex;
        flex-wrap: wrap; /* Allow wrapping on smaller screens */
        gap: 2rem; /* Space between left and right columns */
      }

      .cart-left {
        flex: 3; /* Takes up more space */
        min-width: 300px; /* Minimum width */
        background-color: var(--color-background-light, #fff);
        padding: var(--spacing-lg, 1.5rem);
        border-radius: var(--border-radius-lg, 0.5rem);
        box-shadow: var(--shadow-sm);
      }

      .cart-left h1 {
        font-size: 1.5rem;
        margin-bottom: var(--spacing-md, 1rem);
        border-bottom: 1px solid var(--color-border, #dee2e6);
        padding-bottom: var(--spacing-sm, 0.5rem);
      }

      .cart-items-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg, 1.5rem);
      }

      .cart-item {
        display: flex;
        gap: var(--spacing-md, 1rem);
        border-bottom: 1px solid var(--color-border, #dee2e6);
        padding-bottom: var(--spacing-lg, 1.5rem);
        flex-wrap: wrap; /* Allow wrapping within item */
      }

      .cart-item-image {
        flex-shrink: 0; /* Prevent image from shrinking */
        width: 100px;
        height: 100px;
      }
      .cart-item-image img {
        width: 100%;
        height: 100%;
        object-fit: contain; /* Or cover */
        border-radius: var(--border-radius-md, 0.375rem);
        border: 1px solid var(--color-border, #dee2e6);
      }

      .cart-item-details {
        flex-grow: 1; /* Take available space */
        min-width: 200px; /* Prevent excessive squishing */
      }
      .cart-item-details h3 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: var(--spacing-xs, 0.25rem);
      }
      .cart-item-details .item-specs {
        font-size: 0.85rem;
        color: var(--color-text-muted, #6c757d);
        margin-bottom: var(--spacing-sm, 0.5rem);
      }
      .cart-item-details .item-stock {
        font-size: 0.85rem;
        color: var(--color-success, #28a745); /* Or danger if out of stock */
        font-weight: 500;
      }

      .cart-item-quantity {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs, 0.25rem);
        margin-top: var(--spacing-sm, 0.5rem); /* Add space above quantity */
      }
      .cart-item-quantity button {
        background-color: var(--color-background-medium, #f8f9fa);
        border: 1px solid var(--color-border, #dee2e6);
        color: var(--color-text-base, #212529);
        border-radius: 50%; /* Circular buttons */
        width: 28px;
        height: 28px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        transition: background-color 0.2s ease;
      }
      .cart-item-quantity button:hover {
        background-color: var(--color-border, #dee2e6);
      }
      .cart-item-quantity input[type="number"] {
        width: 40px;
        text-align: center;
        border: 1px solid var(--color-border, #dee2e6);
        border-radius: var(--border-radius-sm, 0.2rem);
        padding: var(--spacing-xs, 0.25rem);
        font-size: 0.9rem;
        /* Hide spinner arrows */
        -moz-appearance: textfield;
      }
      .cart-item-quantity input[type="number"]::-webkit-outer-spin-button,
      .cart-item-quantity input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .cart-item-actions {
        margin-top: var(--spacing-sm, 0.5rem);
      }
      .cart-item-actions .remove-item-btn {
        background: none;
        border: none;
        color: var(--color-primary, #007bff);
        font-size: 0.85rem;
        cursor: pointer;
        padding: 0;
      }
      .cart-item-actions .remove-item-btn:hover {
        color: var(--color-danger, #dc3545);
        text-decoration: underline;
      }

      .cart-item-actions .save-for-later-btn,
      .cart-item-actions .move-to-cart-btn,
      .cart-item-actions .delete-saved-btn {
          background: none;
          border: none;
          color: var(--color-primary, #007bff);
          font-size: 0.85rem;
          cursor: pointer;
          padding: 0;
      }
      .cart-item-actions .save-for-later-btn:hover,
      .cart-item-actions .move-to-cart-btn:hover,
      .cart-item-actions .delete-saved-btn:hover {
          color: var(--color-danger, #dc3545);
          text-decoration: underline;
      }
      .saved-for-later-section h2 {
          font-size: 1.25rem;
          margin-bottom: 1rem;
      }

      .cart-item-price-section {
        text-align: right;
        min-width: 100px; /* Ensure price doesn't wrap too easily */
        margin-left: auto; /* Push to the right */
      }
      .cart-item-price-section .unit-price {
        font-size: 0.85rem;
        color: var(--color-text-muted, #6c757d);
      }
      .cart-item-price-section .item-subtotal {
        font-size: 1rem;
        font-weight: 600;
        color: var(--color-text-base, #212529);
      }

      .cart-subtotal-row {
        text-align: right;
        margin-top: var(--spacing-md, 1rem);
        font-size: 1.1rem;
        font-weight: 600;
      }

      .empty-cart-message {
        text-align: center;
        padding: var(--spacing-xl, 2rem);
        color: var(--color-text-muted, #6c757d);
      }
      .empty-cart-message h2 {
        font-size: 1.2rem;
        margin-bottom: var(--spacing-sm, 0.5rem);
      }
      .empty-cart-message a {
        font-weight: 600;
      }

      .cart-right {
        flex: 1; /* Takes less space */
        min-width: 280px;
        position: sticky; /* Make summary sticky */
        top: calc(
          var(--nav-height, 60px) + 1rem
        ); /* Adjust based on actual nav height */
        align-self: flex-start; /* Align to top */
      }

      .cart-summary {
        background-color: var(--color-background-light, #fff);
        padding: var(--spacing-lg, 1.5rem);
        border-radius: var(--border-radius-lg, 0.5rem);
        box-shadow: var(--shadow-sm);
      }
      .cart-summary h2 {
        font-size: 1.2rem;
        margin-bottom: var(--spacing-md, 1rem);
        border-bottom: 1px solid var(--color-border, #dee2e6);
        padding-bottom: var(--spacing-sm, 0.5rem);
      }
      .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-sm, 0.5rem);
        font-size: 0.95rem;
      }
      .summary-item span:first-child {
        color: var(--color-text-muted, #6c757d);
      }
      .summary-item span:last-child {
        font-weight: 500;
      }
      .cart-summary hr {
        border: none;
        border-top: 1px solid var(--color-border, #dee2e6);
        margin: var(--spacing-md, 1rem) 0;
      }
      .summary-total {
        display: flex;
        justify-content: space-between;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: var(--spacing-lg, 1.5rem);
      }
      .checkout-button {
        width: 100%;
        padding: 0.8rem;
        background-color: var(--color-primary, #007bff); /* Use theme color */
        color: var(--color-text-light, #fff);
        border: none;
        border-radius: var(--border-radius-md, 0.375rem);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      .checkout-button:hover {
        background-color: var(
          --color-primary-dark,
          #0056b3
        ); /* Use theme color */
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .cart-main {
          flex-direction: column; /* Stack left and right */
        }
        .cart-right {
          position: static; /* Remove sticky positioning */
          width: 100%;
        }
        .cart-item {
          /* Adjust item layout if needed */
        }
        .cart-item-price-section {
          margin-left: 0; /* Reset margin */
          text-align: left;
          margin-top: var(--spacing-sm, 0.5rem);
          width: 100%; /* Take full width */
        }
      }
    </style>
{% endblock extra_css %}

{% block content %} {# <<< START OF CART-SPECIFIC CONTENT #}
    <!-- Main Cart Content -->
    <div class="cart-page-container">
      <div class="cart-main">
        <!-- Left Column: Cart Items -->
        <div class="cart-left">
          <h1>Shopping Cart</h1>
          {% csrf_token %} {# Add token for AJAX requests #}

          <div class="cart-items-list"
               data-remove-url-template="{% url 'core:remove_from_cart' 0 %}"
               data-update-url-template="{% url 'core:update_cart_item' 0 %}"
               data-save-url-template="{% url 'core:save_for_later' 0 %}"
               data-move-url-template="{% url 'core:move_to_cart' 0 %}"
               data-delete-saved-url-template="{% url 'core:delete_saved_item' 0 %}">
            {# --- Start Loop Here in Django --- #}
            {% for item in cart_items %}
                <div class="cart-item" data-item-id="{{ item.id }}">
                  
                  {# --- IMAGE --- #}
                  <div class="cart-item-image">
                    {% if item.product %}
                        {% with first_image=item.product.images.first %}
                            {% if first_image.image.url %}
                                <img src="{{ first_image.image.url }}" alt="{{ item.name }}">
                            {% else %}
                                <img src="{% static 'assets/img/placeholder.png' %}" alt="Placeholder">
                            {% endif %}
                        {% endwith %}
                    {% elif item.service_package %}
                        {% with first_image=item.service_package.service.images.first %}
                            {% if first_image.image.url %}
                                <img src="{{ first_image.image.url }}" alt="{{ item.name }}">
                            {% else %}
                                <img src="{% static 'assets/img/placeholder.png' %}" alt="Placeholder">
                            {% endif %}
                        {% endwith %}
                    {% else %}
                        <img src="{% static 'assets/img/placeholder.png' %}" alt="Placeholder">
                    {% endif %}
                  </div>

                  <div class="cart-item-details">
                    
                    {# --- NAME --- #}
                    <h3>{{ item.name }}</h3>
                    
                    {# --- SPECS (Sold by / Offered by) --- #}
                    <div class="item-specs">
                        {% if item.product %}
                            {% with vendor=item.product.vendor %}
                                <span class="d-block">
                                    Sold by:
                                    {% if vendor %}
                                        <a href="{{ vendor.get_absolute_url }}">{{ vendor.name }}</a>
                                    {% else %}
                                        NEXUS
                                    {% endif %}
                                </span>
                            {% endwith %}
                        {% elif item.service_package %}
                            {% with provider=item.service_package.service.provider %}
                                <span class="d-block">
                                    Offered by:
                                    {% if provider %}
                                        <a href="{% url 'core:provider_profile_detail' username=provider.username %}">{{ provider.get_full_name|default:provider.username }}</a>
                                    {% else %}
                                        NEXUS
                                    {% endif %}
                                </span>
                            {% endwith %}
                        {% endif %}
                    </div>

                    {# --- STOCK STATUS --- #}
                    <div class="item-stock">
                        {% if item.product %}
                            {% if item.product.is_in_stock %}
                                In Stock
                            {% else %}
                                <span class="text-danger">Out of Stock</span>
                            {% endif %}
                        {% elif item.service_package %}
                            <span class="text-info">Service</span>
                        {% else %}
                            {# Fallback for unknown item type #}
                        {% endif %}
                    </div>

                    {# --- QUANTITY CONTROLS --- #}
                    {% if item.product and item.product.product_type == 'physical' %}
                        <div class="cart-item-quantity">
                            <button class="quantity-change" data-change="-1" data-item-id="{{ item.id }}">-</button>
                            <input
                              type="number"
                              value="{{ item.quantity }}"
                              min="1"
                              max="{{ item.product.stock|default:99 }}"
                              class="item-quantity-input"
                              aria-label="Item Quantity"
                              data-item-id="{{ item.id }}"
                            />
                            <button class="quantity-change" data-change="1" data-item-id="{{ item.id }}">+</button>
                        </div>
                    {% endif %}

                    {# --- ACTIONS (Remove button) --- #}
                    <div class="cart-item-actions">
                      <button class="remove-item-btn" data-item-id="{{ item.id }}">
                        Remove
                      </button>
                      <span class="mx-1 text-muted">|</span>
                      <button class="save-for-later-btn" data-item-id="{{ item.id }}">
                        Save for Later
                      </button>
                    </div>
                  </div>

                  {# --- PRICE SECTION --- #}
                  <div class="cart-item-price-section">
                    <div class="unit-price">{{ settings.DEFAULT_CURRENCY_SYMBOL|default:'$' }}{{ item.price|floatformat:2 }}</div>
                    <div class="item-subtotal" data-unit-price="{{ item.price }}">
                      {{ settings.DEFAULT_CURRENCY_SYMBOL|default:'$' }}{{ item.total_item_price|floatformat:2|intcomma }} {# Use calculated total #}
                    </div>
                  </div>
                </div>
            {% empty %} {# --- Display if cart_items is empty --- #}
                <div class="empty-cart-message">
                  <h2>Your NEXUS Cart is empty.</h2>
                  <p>Check out Today's Deals or continue shopping.</p>
                  <p><a href="{% url 'core:home' %}">Continue Shopping</a></p> {# Corrected home link #}
                </div>
            {% endfor %}
            {# --- End Loop Here --- #}
          </div>

          <!-- Subtotal Display (Optional, often just in summary) -->
          {% if cart_items %} {# Only show if cart is not empty #}
          <div class="cart-subtotal-row">
            Subtotal (<span id="cart-item-count-display">{{ cart_items|length }}</span> items): {# Dynamic count #}
            <span id="cart-subtotal-display-left">{{ settings.DEFAULT_CURRENCY_SYMBOL|default:'$' }}{{ cart_total|floatformat:2|intcomma }}</span> {# Dynamic total #}
          </div>
          {% endif %}

          <!-- Saved For Later Section -->
          <div id="saved-for-later-container">
            {% if saved_for_later_items %}
            <div class="saved-for-later-section mt-5">
                <h2 class="h4 border-top pt-4">Saved for Later (<span id="saved-items-count">{{ saved_for_later_items|length }}</span> items)</h2>
                <div class="saved-items-list">
                    {% for saved_item in saved_for_later_items %}
                        <div class="cart-item saved-item" data-saved-item-id="{{ saved_item.id }}">
                            <!-- Image -->
                            <div class="cart-item-image">
                                {% if saved_item.product %}
                                    {% with first_image=saved_item.product.images.first %}
                                        {% if first_image.image.url %}
                                            <img src="{{ first_image.image.url }}" alt="{{ saved_item.name }}">
                                        {% else %}
                                            <img src="{% static 'assets/img/placeholder.png' %}" alt="Placeholder">
                                        {% endif %}
                                    {% endwith %}
                                {% elif saved_item.service_package %}
                                    {% with first_image=saved_item.service_package.service.images.first %}
                                        {% if first_image.image.url %}
                                            <img src="{{ first_image.image.url }}" alt="{{ saved_item.name }}">
                                        {% else %}
                                            <img src="{% static 'assets/img/placeholder.png' %}" alt="Placeholder">
                                        {% endif %}
                                    {% endwith %}
                                {% else %}
                                    <img src="{% static 'assets/img/placeholder.png' %}" alt="Placeholder">
                                {% endif %}
                            </div>
                            <!-- Details -->
                            <div class="cart-item-details">
                                <h3>{{ saved_item.name }}</h3>
                                <div class="item-specs">Quantity: <span class="saved-item-quantity">{{ saved_item.quantity }}</span></div>
          
                                <div class="cart-item-actions">
                                    <button class="move-to-cart-btn" data-saved-item-id="{{ saved_item.id }}">
                                        Move to Cart
                                    </button>
                                    <span class="mx-1 text-muted">|</span>
                                    <button class="delete-saved-btn" data-saved-item-id="{{ saved_item.id }}">
                                        Delete
                                    </button>
                                </div>
                            </div>
                            <!-- Price -->
                            <div class="cart-item-price-section">
                                <div class="item-subtotal">{{ settings.DEFAULT_CURRENCY_SYMBOL|default:'$' }}{{ saved_item.price|floatformat:2|intcomma }}</div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
          </div>
        </div>
        <!-- End cart-left -->

        <!-- Right Column: Order Summary -->
        {% if cart_items %} {# Only show summary if cart is not empty #}
        <div class="cart-right">
          <div class="cart-summary">
            <h2>Order Summary</h2>
            <div class="summary-item">
              <span
                >Subtotal (<span id="cart-item-count-summary">{{ cart_items|length }}</span>
                items)</span
              >
              <span id="summary-subtotal">{{ settings.DEFAULT_CURRENCY_SYMBOL|default:'$' }}{{ cart_total|floatformat:2|intcomma }}</span> {# Dynamic total #}
            </div>
            <div class="summary-item">
              <span>Shipping</span>
              <span id="summary-shipping">Free</span> {# TODO: Calculate shipping later #}
            </div>
            <div class="summary-item">
              <span>Estimated Tax</span>
              <span id="summary-tax">{{ settings.DEFAULT_CURRENCY_SYMBOL|default:'$' }}0.00</span> {# TODO: Calculate tax later #}
            </div>
            <hr />
            <div class="summary-total">
              <span>Order total</span>
              <span id="summary-total">{{ settings.DEFAULT_CURRENCY_SYMBOL|default:'$' }}{{ cart_total|floatformat:2|intcomma }}</span> {# TODO: Add tax/shipping later #}
            </div>
            {# --- Link to checkout (defined in main urls.py) --- #}
            <form action="{% url 'core:checkout' %}" method="GET">
              {# Or POST depending on your checkout flow #}
              <button type="submit" class="checkout-button">
                Proceed to Checkout
              </button>
            </form>
          </div>
        </div>
        {% endif %}
        <!-- End cart-right -->
      </div>
      <!-- End cart-main -->
    </div>
    <!-- End cart-page-container -->

{% endblock content %} {# <<< END OF CART-SPECIFIC CONTENT #}

{% block extra_js %}
    {{ block.super }} {# <<< ADD THIS LINE #}
    <!-- Link your cart JavaScript file if needed for quantity updates etc. -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
          const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
          const cartItemsList = document.querySelector('.cart-items-list');
          const removeUrlTemplate = cartItemsList.dataset.removeUrlTemplate;
          const updateUrlTemplate = cartItemsList.dataset.updateUrlTemplate;
          const saveUrlTemplate = cartItemsList.dataset.saveUrlTemplate;
          const moveUrlTemplate = cartItemsList.dataset.moveUrlTemplate;
          const deleteSavedUrlTemplate = cartItemsList.dataset.deleteSavedUrlTemplate;
          const cartLeftContainer = document.querySelector('.cart-left');
          const currencySymbol = "{{ settings.DEFAULT_CURRENCY_SYMBOL|default:'$' }}";

          // --- Helper function to update cart summary ---
          function updateCartSummary(data) {
              // Update counts
              const itemCountDisplay = document.getElementById('cart-item-count-display');
              const itemCountSummary = document.getElementById('cart-item-count-summary');
              if (itemCountDisplay) itemCountDisplay.textContent = data.cart_items_count;
              if (itemCountSummary) itemCountSummary.textContent = data.cart_items_count;

              // Update totals
              const cartSubtotalLeft = document.getElementById('cart-subtotal-display-left');
              const summarySubtotal = document.getElementById('summary-subtotal');
              const summaryTotal = document.getElementById('summary-total');
              
              // The view now provides a pre-formatted string for the total
              const formattedTotal = currencySymbol + data.cart_total;

              if (cartSubtotalLeft) cartSubtotalLeft.textContent = formattedTotal;
              if (summarySubtotal) summarySubtotal.textContent = formattedTotal;
              if (summaryTotal) summaryTotal.textContent = formattedTotal; // Assumes total is same as subtotal for now
          }

          // --- Helper to update a single item's subtotal ---
          function updateItemSubtotal(itemId, newSubtotal) {
              const itemElement = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);
              if (itemElement) {
                  const subtotalElement = itemElement.querySelector('.item-subtotal');
                  if (subtotalElement) {
                      subtotalElement.textContent = currencySymbol + newSubtotal;
                  }
              }
          }

          // --- Logic for removing an item from the cart ---
          cartLeftContainer.addEventListener('click', function(event) {
              if (event.target.classList.contains('remove-item-btn')) { // REMOVE FROM CART
                  const button = event.target;
                  const itemId = button.dataset.itemId;
                  const url = removeUrlTemplate.replace('/0/', `/${itemId}/`);

                  fetch(url, {
                      method: 'POST',
                      headers: {
                          'X-CSRFToken': csrfToken,
                          'X-Requested-With': 'XMLHttpRequest' // To identify AJAX requests on the server
                      },
                  })
                  .then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          // Remove the item's HTML element from the DOM
                          const cartItemElement = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);
                          if (cartItemElement) {
                              cartItemElement.remove();
                          }
                          
                          updateCartSummary(data);

                          // Check if cart is now empty
                          if (data.cart_items_count === 0) {
                              const cartRight = document.querySelector('.cart-right');
                              if(cartRight) cartRight.remove();
                              
                              const emptyCartHTML = `
                                  <div class="empty-cart-message">
                                    <h2>Your NEXUS Cart is empty.</h2>
                                    <p>Check out Today's Deals or continue shopping.</p>
                                    <p><a href="{% url 'core:home' %}">Continue Shopping</a></p>
                                  </div>
                              `;
                              const subtotalRow = document.querySelector('.cart-subtotal-row');
                              if (cartItemsList) cartItemsList.innerHTML = emptyCartHTML;
                              if (subtotalRow) subtotalRow.remove();
                          }
                      } else {
                          alert(data.error || 'There was an error removing the item.');
                      }
                  })
                  .catch(error => console.error('Error removing item:', error));
              }

              // --- Logic for changing quantity with +/- buttons --- (in cart)
              if (event.target.classList.contains('quantity-change')) {
                  const button = event.target;
                  const itemId = button.dataset.itemId;
                  const change = parseInt(button.dataset.change, 10);
                  const itemElement = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);
                  const quantityInput = itemElement.querySelector('.item-quantity-input');

                  let newQuantity = parseInt(quantityInput.value, 10) + change;

                  if (newQuantity < 1) {
                      return; // Don't allow quantity to go below 1 with buttons
                  }

                  // Send the update to the server
                  sendQuantityUpdate(itemId, newQuantity, quantityInput);
              }

              // --- Logic for saving an item for later ---
              if (event.target.classList.contains('save-for-later-btn')) {
                  const button = event.target;
                  const itemId = button.dataset.itemId;
                  const url = saveUrlTemplate.replace('/0/', `/${itemId}/`);

                  fetch(url, {
                      method: 'POST',
                      headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
                  })
                  .then(response => response.json())
                  .then(data => {
                    if (data.success) {
                        // 1. Remove the item from the cart list
                        const cartItemElement = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);
                        if (cartItemElement) {
                            cartItemElement.remove();
                        }

                        // 2. Update the main cart summary
                        updateCartSummary(data);

                        // 3. Handle the "Saved for Later" section
                        let savedForLaterContainer = document.getElementById('saved-for-later-container');
                        let savedItemsList;

                        // Check if the saved for later section exists. If not, create it.
                        if (!savedForLaterContainer.querySelector('.saved-for-later-section')) {
                            savedForLaterContainer.innerHTML = `
                                <div class="saved-for-later-section mt-5">
                                    <h2 class="h4 border-top pt-4">Saved for Later (<span id="saved-items-count">0</span> items)</h2>
                                    <div class="saved-items-list"></div>
                                </div>
                            `;
                        }
                        
                        savedItemsList = savedForLaterContainer.querySelector('.saved-items-list');
                        
                        const savedItem = data.saved_item;

                        if (data.created_new_saved_item) {
                            // 4a. If it's a new item, create and append the element
                            const newSavedItemHTML = `
                                <div class="cart-item saved-item" data-saved-item-id="${savedItem.id}">
                                    <div class="cart-item-image">
                                        <img src="${savedItem.image_url}" alt="${savedItem.name}">
                                    </div>
                                    <div class="cart-item-details">
                                        <h3>${savedItem.name}</h3>
                                        <div class="item-specs">Quantity: <span class="saved-item-quantity">${savedItem.quantity}</span></div>
                                        <div class="cart-item-actions">
                                            <button class="move-to-cart-btn" data-saved-item-id="${savedItem.id}">
                                                Move to Cart
                                            </button>
                                            <span class="mx-1 text-muted">|</span>
                                            <button class="delete-saved-btn" data-saved-item-id="${savedItem.id}">
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                    <div class="cart-item-price-section">
                                        <div class="item-subtotal">${currencySymbol}${savedItem.price}</div>
                                    </div>
                                </div>
                            `;
                            savedItemsList.insertAdjacentHTML('beforeend', newSavedItemHTML);
                        } else {
                            // 4b. If it's an existing item, find it and update its quantity
                            const existingSavedItemEl = savedItemsList.querySelector(`.saved-item[data-saved-item-id="${savedItem.id}"]`);
                            if (existingSavedItemEl) {
                                const quantityEl = existingSavedItemEl.querySelector('.saved-item-quantity');
                                if (quantityEl) {
                                    quantityEl.textContent = savedItem.quantity;
                                }
                            } else {
                                // Fallback: if element not found (e.g., if saved list was empty on page load), just reload.
                                window.location.reload();
                                return;
                            }
                        }

                        // 5. Update the saved items count
                        const savedItemsCountEl = document.getElementById('saved-items-count');
                        if (savedItemsCountEl) {
                            savedItemsCountEl.textContent = data.saved_items_count;
                        }

                        // 6. Check if cart is now empty and update UI accordingly
                        if (data.cart_items_count === 0) {
                            const cartRight = document.querySelector('.cart-right');
                            if(cartRight) cartRight.remove();
                            
                            const emptyCartHTML = `
                                <div class="empty-cart-message">
                                  <h2>Your NEXUS Cart is empty.</h2>
                                  <p>Check out Today's Deals or continue shopping.</p>
                                  <p><a href="{% url 'core:home' %}">Continue Shopping</a></p>
                                </div>
                            `;
                            const subtotalRow = document.querySelector('.cart-subtotal-row');
                            if (cartItemsList) cartItemsList.innerHTML = emptyCartHTML;
                            if (subtotalRow) subtotalRow.remove();
                        }

                    } else {
                        alert(data.error || 'Could not save item for later.');
                    }
                  })
                  .catch(error => console.error('Error saving item for later:', error));
              }

              // --- Logic for moving an item to the cart ---
              if (event.target.classList.contains('move-to-cart-btn')) {
                  const button = event.target;
                  const savedItemId = button.dataset.savedItemId;
                  const url = moveUrlTemplate.replace('/0/', `/${savedItemId}/`);

                  fetch(url, {
                      method: 'POST',
                      headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
                  })
                  .then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          window.location.reload();
                      } else {
                          alert(data.error || 'Could not move item to cart.');
                      }
                  })
                  .catch(error => console.error('Error moving item to cart:', error));
              }

              // --- Logic for deleting a saved item ---
              if (event.target.classList.contains('delete-saved-btn')) {
                  const button = event.target;
                  const savedItemId = button.dataset.savedItemId;
                  const url = deleteSavedUrlTemplate.replace('/0/', `/${savedItemId}/`);

                  fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' } })
                  .then(response => response.json())
                  .then(data => { if (data.success) { window.location.reload(); } else { alert(data.error || 'Could not delete saved item.'); } })
                  .catch(error => console.error('Error deleting saved item:', error));
              }
          });

          // --- Function to send the AJAX quantity update ---
          function sendQuantityUpdate(itemId, quantity, inputElement) {
              const url = updateUrlTemplate.replace('/0/', `/${itemId}/`);

              fetch(url, {
                  method: 'POST',
                  headers: {
                      'X-CSRFToken': csrfToken,
                      'Content-Type': 'application/json',
                      'X-Requested-With': 'XMLHttpRequest'
                  },
                  body: JSON.stringify({ quantity: quantity })
              })
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      // Update UI with confirmed data from server
                      inputElement.value = data.new_quantity;
                      updateItemSubtotal(itemId, data.item_subtotal);
                      updateCartSummary(data);
                  } else {
                      // Revert the input value if server rejects the change
                      inputElement.value = data.new_quantity || (quantity - 1); // Revert to previous or suggested
                      alert(data.error || 'Could not update quantity.');
                  }
              })
              .catch(error => {
                  console.error('Error updating quantity:', error);
                  alert('An error occurred. Please try again.');
              });
          }
      });
    </script>
{% endblock extra_js %}
