{% extends 'base.html' %} {# <<< EXTEND THE BASE TEMPLATE #}
{% load static %}
{% load humanize %} {# <<< LOAD HUMANIZED FOR CURRENCY FORMATTING #}

{% block title %}Shopping Cart - NEXUS{% endblock title %}

{% block extra_css %}
    {# Link cart-specific CSS #}
    <link rel="stylesheet" href="{% static 'assets/css/cart.css' %}" />
    {# Add specific cart styles below or keep in cart.css #}
    <style>
      /* Basic Cart Layout Styles (Add more specific styles to cart.css) */
      .cart-page-container {
        max-width: 1200px;
        margin: 2rem auto; /* Add margin */
        padding: 0 1rem; /* Add padding */
      }

      .cart-main {
        display: flex;
        flex-wrap: wrap; /* Allow wrapping on smaller screens */
        gap: 2rem; /* Space between left and right columns */
      }

      .cart-left {
        flex: 3; /* Takes up more space */
        min-width: 300px; /* Minimum width */
        background-color: var(--color-background-light, #fff);
        padding: var(--spacing-lg, 1.5rem);
        border-radius: var(--border-radius-lg, 0.5rem);
        box-shadow: var(--shadow-sm);
      }

      .cart-left h1 {
        font-size: 1.5rem;
        margin-bottom: var(--spacing-md, 1rem);
        border-bottom: 1px solid var(--color-border, #dee2e6);
        padding-bottom: var(--spacing-sm, 0.5rem);
      }

      .cart-items-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg, 1.5rem);
      }

      .cart-item {
        display: flex;
        gap: var(--spacing-md, 1rem);
        border-bottom: 1px solid var(--color-border, #dee2e6);
        padding-bottom: var(--spacing-lg, 1.5rem);
        flex-wrap: wrap; /* Allow wrapping within item */
      }

      .cart-item-image {
        flex-shrink: 0; /* Prevent image from shrinking */
        width: 100px;
        height: 100px;
      }
      .cart-item-image img {
        width: 100%;
        height: 100%;
        object-fit: contain; /* Or cover */
        border-radius: var(--border-radius-md, 0.375rem);
        border: 1px solid var(--color-border, #dee2e6);
      }

      .cart-item-details {
        flex-grow: 1; /* Take available space */
        min-width: 200px; /* Prevent excessive squishing */
      }
      .cart-item-details h3 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: var(--spacing-xs, 0.25rem);
      }
      .cart-item-details .item-specs {
        font-size: 0.85rem;
        color: var(--color-text-muted, #6c757d);
        margin-bottom: var(--spacing-sm, 0.5rem);
      }
      .cart-item-details .item-stock {
        font-size: 0.85rem;
        color: var(--color-success, #28a745); /* Or danger if out of stock */
        font-weight: 500;
      }

      .cart-item-quantity {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs, 0.25rem);
        margin-top: var(--spacing-sm, 0.5rem); /* Add space above quantity */
      }
      .cart-item-quantity button {
        background-color: var(--color-background-medium, #f8f9fa);
        border: 1px solid var(--color-border, #dee2e6);
        color: var(--color-text-base, #212529);
        border-radius: 50%; /* Circular buttons */
        width: 28px;
        height: 28px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        transition: background-color 0.2s ease;
      }
      .cart-item-quantity button:hover {
        background-color: var(--color-border, #dee2e6);
      }
      .cart-item-quantity input[type="number"] {
        width: 40px;
        text-align: center;
        border: 1px solid var(--color-border, #dee2e6);
        border-radius: var(--border-radius-sm, 0.2rem);
        padding: var(--spacing-xs, 0.25rem);
        font-size: 0.9rem;
        /* Hide spinner arrows */
        -moz-appearance: textfield;
      }
      .cart-item-quantity input[type="number"]::-webkit-outer-spin-button,
      .cart-item-quantity input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .cart-item-actions {
        margin-top: var(--spacing-sm, 0.5rem);
      }
      .cart-item-actions .remove-item-btn {
        background: none;
        border: none;
        color: var(--color-primary, #007bff);
        font-size: 0.85rem;
        cursor: pointer;
        padding: 0;
      }
      .cart-item-actions .remove-item-btn:hover {
        color: var(--color-danger, #dc3545);
        text-decoration: underline;
      }

      .cart-item-price-section {
        text-align: right;
        min-width: 100px; /* Ensure price doesn't wrap too easily */
        margin-left: auto; /* Push to the right */
      }
      .cart-item-price-section .unit-price {
        font-size: 0.85rem;
        color: var(--color-text-muted, #6c757d);
      }
      .cart-item-price-section .item-subtotal {
        font-size: 1rem;
        font-weight: 600;
        color: var(--color-text-base, #212529);
      }

      .cart-subtotal-row {
        text-align: right;
        margin-top: var(--spacing-md, 1rem);
        font-size: 1.1rem;
        font-weight: 600;
      }

      .empty-cart-message {
        text-align: center;
        padding: var(--spacing-xl, 2rem);
        color: var(--color-text-muted, #6c757d);
      }
      .empty-cart-message h2 {
        font-size: 1.2rem;
        margin-bottom: var(--spacing-sm, 0.5rem);
      }
      .empty-cart-message a {
        font-weight: 600;
      }

      .cart-right {
        flex: 1; /* Takes less space */
        min-width: 280px;
        position: sticky; /* Make summary sticky */
        top: calc(
          var(--nav-height, 60px) + 1rem
        ); /* Adjust based on actual nav height */
        align-self: flex-start; /* Align to top */
      }

      .cart-summary {
        background-color: var(--color-background-light, #fff);
        padding: var(--spacing-lg, 1.5rem);
        border-radius: var(--border-radius-lg, 0.5rem);
        box-shadow: var(--shadow-sm);
      }
      .cart-summary h2 {
        font-size: 1.2rem;
        margin-bottom: var(--spacing-md, 1rem);
        border-bottom: 1px solid var(--color-border, #dee2e6);
        padding-bottom: var(--spacing-sm, 0.5rem);
      }
      .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-sm, 0.5rem);
        font-size: 0.95rem;
      }
      .summary-item span:first-child {
        color: var(--color-text-muted, #6c757d);
      }
      .summary-item span:last-child {
        font-weight: 500;
      }
      .cart-summary hr {
        border: none;
        border-top: 1px solid var(--color-border, #dee2e6);
        margin: var(--spacing-md, 1rem) 0;
      }
      .summary-total {
        display: flex;
        justify-content: space-between;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: var(--spacing-lg, 1.5rem);
      }
      .checkout-button {
        width: 100%;
        padding: 0.8rem;
        background-color: var(--color-primary, #007bff); /* Use theme color */
        color: var(--color-text-light, #fff);
        border: none;
        border-radius: var(--border-radius-md, 0.375rem);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      .checkout-button:hover {
        background-color: var(
          --color-primary-dark,
          #0056b3
        ); /* Use theme color */
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .cart-main {
          flex-direction: column; /* Stack left and right */
        }
        .cart-right {
          position: static; /* Remove sticky positioning */
          width: 100%;
        }
        .cart-item {
          /* Adjust item layout if needed */
        }
        .cart-item-price-section {
          margin-left: 0; /* Reset margin */
          text-align: left;
          margin-top: var(--spacing-sm, 0.5rem);
          width: 100%; /* Take full width */
        }
      }
    </style>
{% endblock extra_css %}

{% block content %} {# <<< START OF CART-SPECIFIC CONTENT #}
    <!-- Main Cart Content -->
    <div class="cart-page-container">
      <div class="cart-main">
        <!-- Left Column: Cart Items -->
        <div class="cart-left">
          <h1>Shopping Cart</h1>

          <div class="cart-items-list">
            {# --- Start Loop Here in Django --- #}
            {% for item in cart_items %}
                <div class="cart-item" data-item-id="{{ item.product.id }}"> {# Use actual product ID #}
                  <div class="cart-item-image">
                    {% with first_product_image=item.product.images.first %}
                        {% if first_product_image and first_product_image.image and first_product_image.image.url %}
                            <img src="{{ first_product_image.image.url }}" alt="{{ item.product.name }}">
                        {% else %}
                            <img src="{% static 'assets/img/placeholder.png' %}" alt="Placeholder"> {# Default placeholder #}
                        {% endif %}
                    {% endwith %}
                  </div>
                  <div class="cart-item-details">
                    <h3>{{ item.product.name }}</h3>
                    <div class="item-specs">
                      {# Add dynamic specs if available, e.g., color, size #}
                      {% if item.product.vendor %}
                        <span class="d-block">Sold by: <a href="{{ item.product.vendor.get_absolute_url }}">{{ item.product.vendor.name }}</a></span>
                      {% endif %}
                    </div>
                    <div class="item-stock">
                      {% if item.product.is_in_stock %}
                        In Stock
                      {% else %}
                        <span class="text-danger">Out of Stock</span>
                      {% endif %}
                    </div>
                    <div class="cart-item-quantity">
                      {# --- TODO: Implement Update Quantity Form/Links --- #}
                      <button class="quantity-change" data-change="-1" data-item-id="{{ item.product.id }}">-</button>
                      <input
                        type="number"
                        value="{{ item.quantity }}"
                        min="1"
                        max="{{ item.product.stock|default:99 }}" {# Use actual stock limit #}
                        class="item-quantity-input"
                        aria-label="Item Quantity"
                        data-item-id="{{ item.product.id }}"
                      />
                      <button class="quantity-change" data-change="1" data-item-id="{{ item.product.id }}">+</button>
                      {# --- END TODO --- #}
                    </div>
                    <div class="cart-item-actions">
                      {# --- TODO: Implement Remove Item Form/Link --- #}
                      <button class="remove-item-btn" data-item-id="{{ item.product.id }}">
                        Remove
                      </button>
                      {# --- END TODO --- #}
                    </div>
                  </div>
                  <div class="cart-item-price-section">
                    <div class="unit-price">${{ item.product.price|floatformat:2 }}</div>
                    <div class="item-subtotal" data-unit-price="{{ item.product.price }}">
                      ${{ item.total_item_price|floatformat:2|intcomma }} {# Use calculated total #}
                    </div>
                  </div>
                </div>
            {% empty %} {# --- Display if cart_items is empty --- #}
                <div class="empty-cart-message">
                  <h2>Your NEXUS Cart is empty.</h2>
                  <p>Check out Today's Deals or continue shopping.</p>
                  <p><a href="{% url 'core:home' %}">Continue Shopping</a></p> {# Corrected home link #}
                </div>
            {% endfor %}
            {# --- End Loop Here --- #}
          </div>

          <!-- Subtotal Display (Optional, often just in summary) -->
          {% if cart_items %} {# Only show if cart is not empty #}
          <div class="cart-subtotal-row">
            Subtotal (<span id="cart-item-count-display">{{ cart_items|length }}</span> items): {# Dynamic count #}
            <span id="cart-subtotal-display-left">${{ cart_total|floatformat:2|intcomma }}</span> {# Dynamic total #}
          </div>
          {% endif %}
        </div>
        <!-- End cart-left -->

        <!-- Right Column: Order Summary -->
        {% if cart_items %} {# Only show summary if cart is not empty #}
        <div class="cart-right">
          <div class="cart-summary">
            <h2>Order Summary</h2>
            <div class="summary-item">
              <span
                >Subtotal (<span id="cart-item-count-summary">{{ cart_items|length }}</span>
                items)</span
              >
              <span id="summary-subtotal">${{ cart_total|floatformat:2|intcomma }}</span> {# Dynamic total #}
            </div>
            <div class="summary-item">
              <span>Shipping</span>
              <span id="summary-shipping">Free</span> {# TODO: Calculate shipping later #}
            </div>
            <div class="summary-item">
              <span>Estimated Tax</span>
              <span id="summary-tax">$0.00</span> {# TODO: Calculate tax later #}
            </div>
            <hr />
            <div class="summary-total">
              <span>Order total</span>
              <span id="summary-total">${{ cart_total|floatformat:2|intcomma }}</span> {# TODO: Add tax/shipping later #}
            </div>
            {# --- Link to checkout (defined in main urls.py) --- #}
            <form action="{% url 'core:checkout' %}" method="GET">
              {# Or POST depending on your checkout flow #}
              <button type="submit" class="checkout-button">
                Proceed to Checkout
              </button>
            </form>
          </div>
        </div>
        {% endif %}
        <!-- End cart-right -->
      </div>
      <!-- End cart-main -->
    </div>
    <!-- End cart-page-container -->

{% endblock content %} {# <<< END OF CART-SPECIFIC CONTENT #}

{% block extra_js %}
    {{ block.super }} {# <<< ADD THIS LINE #}
    <!-- Link your cart JavaScript file if needed for quantity updates etc. -->
    {# <script src="{% static 'assets/js/cart.js' %}"></script> #}
{% endblock extra_js %}
