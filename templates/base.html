{% load static %}
{% load i18n %} {# <<< Load the i18n tags #}
{% load rider_tags %} {# Load your custom rider template tags #}
{% load notification_tags %} {# Load your notification tags #}
<!DOCTYPE html>
<html lang="{{ current_language|default:"en" }}"> {# <<< Make lang dynamic, default to 'en' if not set #}
<head lang="{{ LANGUAGE_CODE|default:"en" }}"> {# Use LANGUAGE_CODE here #}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {# Default title, can be overridden by child templates using {% block title %} #}
    <title>{% block title %}NEXUS{% endblock title %}</title>


    {# --- ADD BOOTSTRAP 5 CSS --- #}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
{# --- END BOOTSTRAP CSS --- #}
{# Bootstrap Icons #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

{# --- START: Font Awesome CDN --- #}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
{# --- END: Font Awesome CDN --- #}

{# Link to CSS file(s) containing styles for nav, footer, and base layout #}
    {# Assuming home.css contains nav/footer styles. Consider creating a dedicated base.css #}
    <link rel="stylesheet" href="{% static 'assets/css/home.css' %}" />

    {% include 'core/partials/_chatbot_ui.html' %}

    {# Block for page-specific CSS links #}
    {% block extra_css %}
        <link rel="stylesheet" href="{% static 'assets/css/category_modal.css' %}"> {# <<< Link the new CSS file #}
        <link rel="stylesheet" href="{% static 'core/css/custom_styles.css' %}">
    {% endblock extra_css %}

    <!-- Google Maps API (if needed globally, or include in specific templates) -->
    {% if settings.GOOGLE_MAPS_API_KEY %}
    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ settings.GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initMap"></script>
    {% endif %}
</head>
<body>

    <!-- ==================== 1. Navigation (Copied from home.html) ==================== -->
    <nav>
        {# --- CORRECTED: Added 'core:' namespace --- #}
        <a href="{% url 'core:home' %}"><img src="{% static 'assets/logo.jpg' %}" width="100" alt="NEXUS" /></a>
        {# --- Added modal trigger --- #}
        <div class="nav-country" data-bs-toggle="modal" data-bs-target="#locationModal" style="cursor: pointer;">
            <img src="{% static 'assets/location_icon.png' %}" height="20" alt="" />
            <div>
                <p>{% trans "Deliver to" %}</p> {# <<< Mark for translation #}
                <h1>{{ delivery_location|default:"United States" }}</h1> {# <<< Use context variable #}
            </div>
        </div>

        {# --- START: Search Form --- #}
        <form class="search-form" action="{% url 'core:search_results' %}" method="get">
            <input type="text" name="q" id="searchInput" class="search-input" placeholder="Search NEXUS..." value="{{ request.GET.q|default:'' }}" />
            <button class="search-button" type="submit" aria-label="{% trans 'Search' %}"> {# <<< Mark aria-label #}
                <svg class="searchIcon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
            </button>
            <button class="mic-button" id="micSearchButton" type="button" title="Search by voice">
                <svg class="micIcon" viewBox="0 0 384 512" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M192 0C139 0 96 43 96 96V256c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-17.7 14.3-32 32-32s32 14.3 32 32v40c0 89.1 66.2 162.7 152 174.4V464H160v48h64v-48h-48v-27.6c85.8-11.7 152-85.3 152-174.4V216c0-17.7 14.3-32 32-32s32 14.3 32 32v40c0 100.7-75.4 184.5-176 197.3V480h16c17.7 0 32 14.3 32 32s-14.3 32-32 32H160c-17.7 0-32-14.3-32-32s14.3-32 32-32h16v-26.7C75.4 440.5 0 356.7 0 256v-40c0-17.7 14.3-32 32-32s32 14.3 32 32v40z"></path></svg>
            </button>
        </form>
        {# --- END: Search Form --- #}

        {# --- Updated Language Section --- #}
        <div class="nav-language" data-bs-toggle="modal" data-bs-target="#languageModal" style="cursor: pointer;">
            <img src="{% static 'assets/us_flag.png' %}" width="22px" alt="US Flag" />
            {# Display current language from context, default to 'en-us' #}
            <span>{{ LANGUAGE_CODE|language_name_local|upper }}</span> {# Use LANGUAGE_CODE here #}
            <img src="{% static 'assets/dropdown_icon.png' %}" class="dropdown-icon" alt="" />
        </div>

        <!-- ===== UPDATED SECTION to trigger Account Modal ===== -->
        {# --- Changed nav-text to be a modal trigger --- #}
        <div class="nav-text" data-bs-toggle="modal" data-bs-target="#accountModal" style="cursor: pointer;">
            {% if user.is_authenticated %}
                <p>Hi, {{ user.username }}!</p>
            {% else %}
                 {# 'signin' is defined in main urls.py - NO namespace needed #}
                <p><a href="{% url 'signin' %}">{% trans "Sign In / Register" %}</a></p> {# <<< Mark for translation #}
            {% endif %}
            <h1>{% trans "Account & Lists" %}</h1> {# <<< Mark for translation #}
            <img src="{% static 'assets/dropdown_icon.png' %}" class="dropdown-icon" alt="" />
        </div>
        <!-- ===== END UPDATED SECTION ===== -->

        <div class="nav-text">
            {# --- CORRECTED: Renamed 'r_o' to 'order_history' and added 'core:' namespace --- #}
            {% if user.is_authenticated %}
                <p><a href="{% url 'core:order_history' %}">{% trans "Returns" %}</a></p>
                <h1>& {% trans "Orders" %}</h1>
            {% else %}
                {# If not logged in, link to signin page, then redirect to order_history. #}
                {# Add a small "(Login)" hint to the link text. #}
                {# 'signin' is assumed to be a global URL name from your main urls.py #}
                <p><a href="{% url 'signin' %}?next={% url 'core:order_history' %}">{% trans "Returns" %} <span class="text-muted" style="font-size: 0.8em;">({% trans "Login" %})</span></a></p>
                <h1>& {% trans "Orders" %}</h1>
            {% endif %}
        </div>
        {# 'cart' is defined in main urls.py - NO namespace needed #}
        <a href="{% url 'cart' %}" class="nav-cart">
            <img src="{% static 'assets/cart_icon.png' %}" width="30px" alt="Shopping Basket" />
            <h4>{% trans "Basket" %}</h4> {# <<< Mark for translation #}
        </a>
    </nav>
    <div class="nav-bottom"> {# Keep the container for styling, but content moves to modal trigger #}
        {# --- START: Changed Menu link to trigger modal --- #}
        <div id="navMenuTrigger" class="nav-bottom-menu-trigger" data-bs-target="#navBottomModal" style="cursor: pointer;"> {# Removed data-bs-toggle, added id #}
            <img src="{% static 'assets/menu_icon.png' %}" width="25px" alt="" />
            <p>{% trans "Menu" %}</p> {# <<< Mark for translation #}
        </div>
        {# --- END: Changed Menu link --- #}
        {# --- START: Restored original nav-bottom links --- #}
        <p><a href="{% url 'core:daily_offers' %}">{% trans "Daily Offers" %}</a></p>
        <p><a href="{% url 'help' %}">{% trans "Support Center" %}</a></p>
        <p><a href="{% url 'core:service_list' %}">{% trans "Services" %}</a></p> {# <<< Added Service Marketplace Link #}
        
        {# --- START: Conditional "Become Rider" or "Categories" Link --- #}
        {% if user|can_apply_as_rider %}
         {# User can apply - show "Become Rider" link #}
                <p>
            <p>
                  <a href="{% url 'core:become_rider_info_page' %}" style="color: inherit; text-decoration: none;">
                    <i class="fas fa-motorcycle me-1"></i>{% trans "Become Rider" %}
                </a>
            </p>
       {% elif user|has_rider_profile %}
                {# User has applied or is a rider - show "Rider Area" link #}
                <p>
                    <a href="{% url 'core:rider_dashboard' %}" style="color: inherit; text-decoration: none;">
                        <i class="fas fa-tachometer-alt me-1"></i>{% trans "Rider Area" %}
                    </a>
                </p>
        {% else %}
        {# User cannot apply and doesn't have a profile (e.g., not logged in) - show Categories #}
            {% if menu_categories %} {# Fallback to Categories if user cannot apply or menu_categories exist #}
            <div class="nav-item dropdown d-inline-block"> {# d-inline-block for nav-bottom #}
                <a class="nav-link dropdown-toggle p-0" href="#" id="navBottomDropdownProductCategories" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="color: inherit; text-decoration: none;">
                    {% trans "Categories" %}
                </a>
                <ul class="dropdown-menu" aria-labelledby="navBottomDropdownProductCategories">
                    {% for category in menu_categories %} {# Use menu_categories here too #}
                        <li><a class="dropdown-item" href="{{ category.get_absolute_url }}">{{ category.name }}</a></li>
                    {% endfor %}
                    <li><hr class="dropdown-divider"></li>
                    {# <li><a class="dropdown-item" href="{% url 'core:category_list' %}">{% trans "All Categories" %}</a></li> #} {# TODO: Create this page and URL later #}
                </ul>
            </div>
            {% endif %}
        {% endif %}
        {# --- END: Conditional "Become Rider" or "Categories" Link --- #}


        {# --- START: Conditional Sell/Dashboard/Help Links --- #}
        {% if user.is_authenticated and user.vendor_profile %}
            {# User is logged in AND is a vendor -> Show Dashboard #}
            <p><a href="{% url 'core:vendor_dashboard' %}">{% trans "Your Dashboard" %}</a></p>
        {% else %}
            {# User is NOT a vendor (or not logged in) -> Show Sell link #}
            <p><a href="{% url 'core:sell_on_nexus' %}">{% trans "Sell on NEXUS" %}</a></p>
        {% endif %}
        {# --- END: Conditional Sell/Dashboard/Help Links --- #}
        {# --- END: Restored original nav-bottom links --- #}
        <span class="nav-promo-caption">✨ WELCOME TO NEXUS! ✨</span>
    </div>
    <!-- ================= End Navigation ================= -->

    {% comment %} --- START: Visual Search UI --- {% endcomment %}
    <div class="container my-4"> {# Added a container for better layout #}
        <div class="visual-search-container my-3 p-3 border rounded bg-light-subtle"> {# Styled container #}
            <h5 class="mb-3">{% trans "Search by Image" %} <i class="bi bi-image-alt"></i></h5>
            <div class="input-group mb-2">
                <input type="file" class="form-control" id="visualSearchInput" accept="image/*" aria-label="{% trans 'Upload image for visual search' %}">
                <button class="btn btn-primary" type="button" id="visualSearchButton" disabled><i class="bi bi-camera-fill"></i> {% trans "Find Similar" %}</button>
            </div>
            <div id="visualSearchPreviewContainer" class="mt-2 text-center" style="display:none;">
                <img id="visualSearchPreview" src="#" alt="Image Preview" style="max-height: 150px; max-width: 100%; border: 1px solid #ddd; padding: 5px; border-radius: .25rem;"/>
            </div>
            <div id="visualSearchSpinner" class="text-center mt-2" style="display:none;">
                <div class="spinner-border text-primary" role="status"><span class="visually-hidden">{% trans "Loading..." %}</span></div>
            </div>
            <div id="visualSearchError" class="alert alert-danger mt-2" role="alert" style="display:none;"></div>
            <div id="visualSearchResults" class="mt-3"></div>
        </div>
    </div>
    {% comment %} --- END: Visual Search UI --- {% endcomment %}

    <main> {# Wrap main content area #}

        {# --- START: Django Messages Display --- #}
        {% if messages %}
            <div class="container mt-3"> {# Optional: Wrap messages in a container for better spacing #}
                {% for message in messages %}
                    {# Map Django message tags to Bootstrap alert classes #}
                    {# Common tags: debug, info, success, warning, error #}
                    <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        {# --- END: Django Messages Display --- #}

        {# This is where the unique content of each child template will be inserted #}
        {% block content %}
        {% endblock content %}
    </main>

    <!-- ==================== Footer (Copied from home.html) ==================== -->
    <footer>
        <div class="footer-back-to-top">
            <a href="#">{% trans "Back to Top" %}</a> {# <<< Mark for translation #}
        </div>
        <div class="footer-content-wrapper">
            <div class="footer-links">
                <div class="footer-column">
                    <h4>{% trans "Get to Know Us" %}</h4> {# <<< Mark for translation #}
                    <ul>
                        <li><a href="#">About NEXUS</a></li>
                        <li><a href="#">Careers</a></li>
                        <li><a href="#">Press Releases</a></li>
                        <li><a href="#">NEXUS Blog</a></li>
                        <li><a href="#">NEXUS Science</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>{% trans "Make Money with Us" %}</h4> {# <<< Mark for translation #}
                    <ul>
                        <li><a href="{% url 'core:sell_on_nexus' %}">Sell on NEXUS</a></li> {# Updated link #}
                        <li><a href="#">Sell on NEXUS Business</a></li>
                        <li><a href="#">Become an Affiliate</a></li>
                        <li><a href="#">Advertise Your Products</a></li>
                        <li><a href="#">Become a Delivery Partner</a></li>
                        <li><a href="#">Self-Publish with Us</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>{% trans "Customer Service" %}</h4> {# <<< Mark for translation #}
                    <ul>
                        {# 'help' is defined in main urls.py - NO namespace needed #}
                        <li><a href="{% url 'help' %}">Help Center</a></li>
                        <li><a href="{% url 'core:user_profile' %}">Your Account</a></li> {# Updated link #}
                        {# 'order_history' is in 'core' namespace #}
                        <li><a href="{% url 'core:order_history' %}">Your Orders</a></li>
                        <li><a href="#">Shipping Rates & Policies</a></li>
                        <li><a href="#">Returns & Replacements</a></li>
                        <li><a href="#">Contact Us</a></li>
                    </ul>
                </div>
                 <div class="footer-column">
                    <h4>{% trans "Policies & Info" %}</h4> {# <<< Mark for translation #}
                    <ul>
                        {# 'privacy' and 'terms' are defined in main urls.py - NO namespace needed #}
                        <li><a href="{% url 'privacy' %}">Privacy Policy</a></li>
                        <li><a href="{% url 'terms' %}">Terms of Service</a></li>
                        <li><a href="#">Accessibility</a></li>
                        <li><a href="#">Gift Cards</a></li>
                        <li><a href="#">Site Map</a></li>
                    </ul>
                </div>
            </div>
            <hr class="footer-divider">
            <div class="footer-secondary">
                 <div class="footer-logo-area">
                     {# --- CORRECTED: Added 'core:' namespace --- #}
                     <a href="{% url 'core:home' %}">
                         <img src="{% static 'assets/logo.jpg' %}" alt="NEXUS Logo">
                     </a>
                 </div>
                 <div class="footer-social">
                    <h4>{% trans "Connect With Us" %}</h4> {# <<< Mark for translation #}
                    {# Add actual links #}
                    <a href="#" aria-label="Facebook" class="social-icon fb"><i class="bi bi-facebook"></i></a>
                    <a href="#" aria-label="Twitter" class="social-icon tw"><i class="bi bi-twitter"></i></a>
                    <a href="#" aria-label="Instagram" class="social-icon ig"><i class="bi bi-instagram"></i></a>
                    <a href="#" aria-label="LinkedIn" class="social-icon li"><i class="bi bi-linkedin"></i></a>
                 </div>
                 <div class="footer-payment">
                    <h4>{% trans "We Accept" %}</h4> {# <<< Mark for translation #}
                    {# Replace with actual icons/images if desired #}
                    <span class="payment-icon visa">Visa</span>
                    <span class="payment-icon mc">MC</span>
                    <span class="payment-icon paypal">PayPal</span>
                    <span class="payment-icon amex">Amex</span>
                 </div>
                 <div class="footer-language-currency">
                     {# Make these functional if needed #}
                     <button>English</button>
                     <button>USD ($)</button>
                     <button>GHANA (GH)</button>
                 </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; {% now "Y" %} NEXUS.com, Inc. or its affiliates. All Rights Reserved.</p>
        </div>

   </footer>
    <!-- ================= End Footer ================= -->

    <!-- ==================== Location Modal ==================== -->
    <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form action="{% url 'core:update_location' %}" method="post">
              {% csrf_token %}
              <div class="modal-header"> {# <<< Mark modal text #}
                <h1 class="modal-title fs-5" id="locationModalLabel">{% trans "Choose your location" %}</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>{% trans "Delivery options and fees may vary based on your location." %}</p>
                {# Simple text input for now - replace with dropdown/zip later #}
                <div class="mb-3">
                  <label for="locationInput" class="form-label">Enter Location (e.g., Country, City, Zip)</label>
                  <input type="text" class="form-control" id="locationInput" name="location_input" placeholder="{{ delivery_location|default:'United States' }}" required>
                </div>
                {# TODO: Add country dropdown, zip code validation etc. here #}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                <button type="submit" class="btn btn-primary">{% trans "Update Location" %}</button>
              </div>
          </form>
        </div>
      </div>
    </div>
    <!-- ================= End Location Modal ================= -->

    <!-- ==================== Language Modal ==================== -->
    <div class="modal fade" id="languageModal" tabindex="-1" aria-labelledby="languageModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form action="{% url 'core:update_language' %}" method="post">
              {% csrf_token %}
              <div class="modal-header"> {# <<< Mark modal text #}
                <h1 class="modal-title fs-5" id="languageModalLabel">{% trans "Choose your language" %}</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>{% trans "Select your preferred language." %}</p>
                {# Simple select dropdown for now #}
                <div class="mb-3">
                  <label for="languageInput" class="form-label">Language</label>
                  <select class="form-select" id="languageInput" name="language_input" required>
                    <option value="en" {% if LANGUAGE_CODE == 'en' %}selected{% endif %}>English</option> {# Match settings.LANGUAGE_CODE #}
                    <option value="es" {% if LANGUAGE_CODE == 'es' %}selected{% endif %}>Español</option>
                    <option value="fr" {% if LANGUAGE_CODE == 'fr' %}selected{% endif %}>Français</option>
                    {# TODO: Add more languages as needed, potentially dynamically from settings.LANGUAGES #}
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                <button type="submit" class="btn btn-primary">{% trans "Update Language" %}</button>
              </div>
          </form>
        </div>
      </div>
    </div>
    <!-- ================= End Language Modal ================= -->

    <!-- ==================== Nav Bottom Modal ==================== -->
    <div class="modal fade" id="navBottomModal" tabindex="-1" aria-labelledby="navBottomModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"> {# Added scrollable #}
        <div class="modal-content">
          <div class="modal-header"> {# <<< Changed title to Categories #}
            <h1 class="modal-title fs-5" id="navBottomModalLabel">{% trans "Shop by Category" %}</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            {# --- START: Display categories from context --- #}
            <ul class="list-unstyled">
                {% if menu_categories %} {# Use menu_categories from context_processor #}
                    {% for category in menu_categories %}
                        <li>
                            <a href="{{ category.get_absolute_url }}">{{ category.name }}</a>
                            {# Optionally display subcategories here if needed #}
                        </li>
                    {% endfor %}
                {% else %}
                    <li>{% trans "No categories available." %}</li>
                {% endif %}
            </ul>
            {# --- END: Display categories --- #}
          </div>
        </div>
      </div>
    </div>
    <!-- ================= End Nav Bottom Modal ================= -->

    <!-- ==================== Account Modal ==================== -->
    <div class="modal fade" id="accountModal" tabindex="-1" aria-labelledby="accountModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="accountModalLabel">{% trans "Your Account" %}</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            {% if user.is_authenticated %}
                <ul class="list-unstyled">
                    <li class="mb-2"><a href="{% url 'core:user_profile' %}" class="text-decoration-none d-block p-2 rounded hover-bg-light"><i class="bi bi-person-circle me-2"></i> {% trans "My Profile" %}</a></li>
                    {# --- START: Offer Service Link --- #}
                    <li class="mb-2"><a href="{% url 'core:service_create' %}" class="text-decoration-none d-block p-2 rounded hover-bg-light"><i class="bi bi-tools me-2"></i> {% trans "Offer a Service" %}</a></li>
                    {# --- END: Offer Service Link --- #}
                    <li class="mb-2"><a href="{% url 'core:order_history' %}" class="text-decoration-none d-block p-2 rounded hover-bg-light"><i class="bi bi-receipt me-2"></i> {% trans "Your Orders" %}</a></li>
                    <li class="mb-2"><a href="{% url 'core:wishlist_detail' %}" class="text-decoration-none d-block p-2 rounded hover-bg-light"><i class="bi bi-heart me-2"></i> {% trans "My Wishlist" %}</a></li>
                            <li class="mb-2"><a href="{% url 'core:customer_notification_list' %}" class="text-decoration-none d-block p-2 rounded hover-bg-light text-primary"><i class="fas fa-bell me-2"></i> {% trans "My Notifications" %} <span class="badge bg-danger notification-badge-nav"></span></a></li>
                    {% if is_provider %} {# <<< Link for Service Providers #}
                    <li class="mb-2"><a href="{% url 'core:provider_dashboard' %}" class="text-decoration-none d-block p-2 rounded hover-bg-light"><i class="bi bi-person-workspace me-2"></i> {% trans "Service Provider Hub" %}</a></li>
                    {% endif %}
                    {% if user.is_authenticated and not user.is_service_provider %} {# Show if authenticated and not already a provider #}
                    <li class="mb-2"><a href="{% url 'core:become_service_provider' %}" class="text-decoration-none d-block p-2 rounded hover-bg-light"><i class="bi bi-briefcase-fill me-2"></i> {% trans "Become a Service Provider" %}</a></li>
                    {% endif %}
                    {% if user.vendor_profile %} {# Check if user has a vendor profile #}
                    <li class="mb-2"><a href="{% url 'core:vendor_dashboard' %}" class="text-decoration-none d-block p-2 rounded hover-bg-light"><i class="bi bi-shop-window me-2"></i> {% trans "Vendor Dashboard" %}</a></li>
                    {% endif %} {# <<< This is the endif we added #}
                    <hr>
                    <li class="mb-2"><a href="{% url 'logout' %}" class="text-danger text-decoration-none d-block p-2 rounded hover-bg-light"><i class="bi bi-box-arrow-right me-2"></i> {% trans "Logout" %}</a></li>
                </ul>
            {% else %}
                <p>{% trans "Please sign in to access your account." %}</p>
                <a href="{% url 'signin' %}" class="btn btn-primary w-100">{% trans "Sign In" %}</a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <!-- ================= End Account Modal ================= -->

    {# --- ADD BOOTSTRAP 5 JS --- #}
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    {# --- END BOOTSTRAP JS --- #}

    {# Global JavaScript files - Add Bootstrap JS etc. if you use them #}
   {# <script src="{% static 'assets/js/script.js' %}"></script> <!-- Temporarily commented out --> #}

<script>
        // Basic initMap function for Google Maps API callback
        // Individual pages will define their own map initialization logic
        function initMap() {
            console.log("Google Maps API loaded and initMap called.");
        }
    </script>

    {# --- START: Voice Search JS --- #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const micButton = document.getElementById('micSearchButton');
            const searchInput = document.getElementById('searchInput'); // Ensure your search input has id="searchInput"

            if (micButton && searchInput) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

                if (SpeechRecognition) {
                    const recognition = new SpeechRecognition();
                    recognition.continuous = false; // Only listen for a single utterance
                    recognition.lang = 'en-US'; // Set language
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;

                    micButton.addEventListener('click', () => {
                        try {
                            recognition.start();
                            micButton.style.color = '#dc3545'; // Indicate listening (e.g., red)
                            console.log("Voice recognition started. Try speaking into the microphone.");
                        } catch(e) {
                            console.error("Voice recognition could not start:", e);
                            micButton.style.color = ''; // Reset color on error
                        }
                    });

                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        searchInput.value = transcript; // Fill the search box
                        console.log('Transcript:', transcript);
                        // Optional: Automatically submit the form
                        // searchInput.closest('form').submit();
                    };

                    recognition.onspeechend = () => {
                        recognition.stop();
                        micButton.style.color = ''; // Reset color
                        console.log("Voice recognition stopped.");
                    };

                    recognition.onerror = (event) => {
                        console.error('Voice recognition error:', event.error);
                        micButton.style.color = ''; // Reset color
                        alert('Error occurred in recognition: ' + event.error);
                    };

                } else {
                    console.warn("Speech Recognition API not supported in this browser.");
                    micButton.style.display = 'none'; // Hide button if not supported
                }
            }
        });
    </script>
    {# --- END: Voice Search JS --- #}

    {# Block for page-specific JavaScript files or inline scripts #}
    {% block extra_js %}
    {# --- Hover JS for Menu Modal --- #}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const menuTrigger = document.getElementById('navMenuTrigger');
            const menuModalElement = document.getElementById('navBottomModal');

            if (menuTrigger && menuModalElement) {
                console.log("Hover script: Trigger and Modal elements found."); // Log: Elements found
                const menuModal = new bootstrap.Modal(menuModalElement);
                let hoverTimeout; // To manage delays

                // Show modal on hover over trigger
                menuTrigger.addEventListener('mouseenter', () => {
                    console.log("Hover script: Mouse entered trigger."); // Log: Enter trigger
                    clearTimeout(hoverTimeout); // Clear any pending hide
                    menuModal.show();
                });

                // Keep modal open if mouse enters the modal itself
                menuModalElement.addEventListener('mouseenter', () => {
                    console.log("Hover script: Mouse entered modal."); // Log: Enter modal
                    clearTimeout(hoverTimeout); // Don't hide if moving into modal
                });

                // Function to start the hide timer
                const startHideTimer = () => {
                    hoverTimeout = setTimeout(() => {
                        console.log("Hover script: Hiding modal (timeout)."); // Log: Hiding
                        menuModal.hide();
                    }, 300); // 300ms delay - slightly longer
                };

                // Start hide timer when leaving trigger OR modal
                menuTrigger.addEventListener('mouseleave', startHideTimer);
                menuModalElement.addEventListener('mouseleave', startHideTimer);

            }
        });
    </script>
    {# --- END Hover JS for Menu Modal --- #}

    {# --- START: Visual Search JavaScript --- #}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const imageInput = document.getElementById('visualSearchInput');
        const searchButton = document.getElementById('visualSearchButton');
        const previewContainer = document.getElementById('visualSearchPreviewContainer');
        const previewImage = document.getElementById('visualSearchPreview');
        const resultsContainer = document.getElementById('visualSearchResults');
        const spinner = document.getElementById('visualSearchSpinner');
        const errorContainer = document.getElementById('visualSearchError');

        let selectedFile = null;

        if (imageInput) {
            imageInput.addEventListener('change', function(event) {
                selectedFile = event.target.files[0];
                if (selectedFile) {
                    previewImage.src = URL.createObjectURL(selectedFile);
                    previewContainer.style.display = 'block';
                    searchButton.disabled = false;
                    errorContainer.style.display = 'none';
                    resultsContainer.innerHTML = ''; // Clear previous results
                } else {
                    previewContainer.style.display = 'none';
                    searchButton.disabled = true;
                    selectedFile = null;
                }
            });
        }

        if (searchButton) {
            searchButton.addEventListener('click', async function() {
                if (!selectedFile) {
                    // Using Bootstrap alert for consistency if possible, or simple alert
                    errorContainer.textContent = "{% trans 'Please select an image first.' %}";
                    errorContainer.style.display = 'block';
                    return;
                }

                spinner.style.display = 'block';
                searchButton.disabled = true;
                errorContainer.style.display = 'none';
                resultsContainer.innerHTML = '';

                const formData = new FormData();
                formData.append('image_file', selectedFile);

                try {
                    const response = await fetch("{% url 'core:ajax_visual_search' %}", {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}', 
                        },
                        body: formData
                    });

                    spinner.style.display = 'none';
                    searchButton.disabled = false; 

                    if (!response.ok) {
                        let errorMsg = `{% trans "Error:" %} ${response.status}`;
                        try {
                            const errData = await response.json();
                            errorMsg = errData.error || `{% trans "Server error:" %} ${response.statusText}`;
                        } catch (e) { /* Ignore if response not JSON */ }
                        errorContainer.textContent = errorMsg;
                        errorContainer.style.display = 'block';
                        return;
                    }

                    const data = await response.json();
                    if (data.suggested_products && data.suggested_products.length > 0) {
                        displayVisualSearchResults(data.suggested_products);
                    } else if (data.error) {
                        errorContainer.textContent = data.error;
                        errorContainer.style.display = 'block';
                    } else {
                        resultsContainer.innerHTML = `<p class="text-muted text-center">{% trans "No similar products found based on the image." %}</p>`;
                    }

                } catch (error) {
                    console.error('Visual Search Error:', error);
                    spinner.style.display = 'none';
                    searchButton.disabled = false;
                    errorContainer.textContent = "{% trans 'An unexpected error occurred. Please try again.' %}";
                    errorContainer.style.display = 'block';
                }
            });
        }

        function displayVisualSearchResults(products) {
            resultsContainer.innerHTML = ''; 
            if (products.length === 0) {
                resultsContainer.innerHTML = `<p class="text-muted text-center">{% trans "No similar products found." %}</p>`;
                return;
            }

            const listGroup = document.createElement('div');
            listGroup.className = 'list-group shadow-sm'; // Added shadow for better visual separation

            products.forEach(product => {
                const productCardHTML = `
                    <a href="${product.absolute_url}" class="list-group-item list-group-item-action d-flex gap-3 py-3" aria-current="true">
                        <img src="${product.image_url}" alt="${product.name}" width="64" height="64" class="rounded-circle flex-shrink-0" style="object-fit: cover;">
                        <div class="d-flex gap-2 w-100 justify-content-between">
                            <div>
                                <h6 class="mb-0">${product.name}</h6>
                                <p class="mb-0 opacity-75 small">{% trans "Category:" %} ${product.category || 'N/A'} - {% trans "Price:" %} GH₵${product.price}</p>
                            </div>
                            <small class="opacity-50 text-nowrap"><i class="bi bi-eye-fill me-1"></i>{% trans "View" %}</small>
                        </div>
                    </a>
                `;
                listGroup.innerHTML += productCardHTML;
            });
            resultsContainer.appendChild(listGroup);
        }
    });
    </script>
    {# --- END: Visual Search JavaScript --- #}
    {% endblock extra_js %}

    
{# Test comment to ensure file is fully parsed #}
</body>
</html>
