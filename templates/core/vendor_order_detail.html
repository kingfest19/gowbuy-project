{% extends "base.html" %}
{% load static i18n humanize fulfillment_filters %}

{% block title %}{% trans "Order Details for Vendor" %} - #{{ order.order_id }}{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        /* Styles adapted from vendor_product_list.html for consistency */
        .list-container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #ebe8e8;
            padding: 2rem 2.5rem;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
            border: 1px solid #959aa0; /* Softer border */
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1.5rem;
            margin-bottom: 2.5rem;
            border-radius: 8px;
            background-color: #ffffff; /* White background */
            border-left: 5px solid #323232ff; /* Prominent black left border */
            border: 1px solid #c7c9cb; /* Subtle border for separation */
        }

        .page-header h1 {
            font-weight: 600;
            color: #323232ff; /* Black text for contrast */
            margin-bottom: 0;
        }

        /* Custom override for the 'Back' button */
        .page-header .btn-outline-secondary {
            background-color: #474747;
            color: #ffffff;
            border-color: #474747;
        }
        .page-header .btn-outline-secondary:hover {
            background-color: #383838;
            border-color: #383838;
        }

        .details-card {
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #f0f2f5;
        }

        .order-item-image img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        #deliveryMapForVendor {
            height: 350px;
            width: 100%;
            border-radius: 8px;
        }
    </style>
{% endblock extra_css %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="list-container">
        <div class="page-header">
            <div>
                <h1>{% trans "Order Details" %} #{{ order.order_id }}</h1>
                <p class="text-muted mb-0">{% blocktrans with date=order.created_at|date:"F d, Y" %}Placed on {{ date }}{% endblocktrans %}</p>
            </div>
            <a href="{% url 'core:vendor_order_list' %}" class="btn btn-lg btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>{% trans "Back to Orders" %}
            </a>
        </div>

        <div class="details-card">
            <div class="row mb-4 pb-4 border-bottom">
                <div class="col-md-6">
                    <h5 class="mb-3">{% trans "Order Information" %}</h5>
                    <p><strong>{% trans "Order Date:" %}</strong> {{ order.created_at|date:"F d, Y H:i" }}</p>
                    <p><strong>{% trans "Status:" %}</strong> <span class="badge rounded-pill {% if order.status == 'COMPLETED' or order.status == 'DELIVERED' %}bg-success{% elif order.status == 'CANCELLED' or order.status == 'REFUNDED' %}bg-danger{% elif order.status == 'PROCESSING' or order.status == 'SHIPPED' %}bg-info text-dark{% elif order.status == 'PENDING_PAYOUT' %}bg-primary{% else %}bg-secondary{% endif %}">{{ order.get_status_display }}</span></p>
                    <p><strong>{% trans "Payment Method:" %}</strong> {{ order.get_payment_method_display }}</p>
                    {% if order.paystack_ref %}
                        <p><strong>{% trans "Paystack Ref:" %}</strong> {{ order.paystack_ref }}</p>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <h5 class="mb-3">{% trans "Customer & Shipping" %}</h5>
                    {% if order.user %}
                        <p><strong>{% trans "Customer:" %}</strong> {{ order.user.get_full_name|default:order.user.username }}</p>
                    {% endif %}
                    {% if order.shipping_address_text %}
                        <p class="mb-1"><strong>{% trans "Shipping Address:" %}</strong></p>
                        <address class="bg-light p-2 rounded" style="white-space: pre-wrap;">{{ order.shipping_address_text }}</address>
                        {% if order.shipping_address.phone_number %}
                            <p><strong>{% trans "Customer Phone:" %}</strong> {{ order.shipping_address.phone_number }}</p>
                        {% endif %}
                    {% else %}
                        <p>{% trans "No shipping address provided (e.g., digital goods or local pickup)." %}</p>
                    {% endif %}
                </div>
            </div>

            {% if show_map and vendor_location_lat and vendor_location_lng and delivery_lat and delivery_lng %}
            <div class="mb-4">
                <h5 class="mb-3">{% trans "Delivery Overview" %}</h5>
                <div id="deliveryMapForVendor"></div>
            </div>
            {% endif %}

            {# --- Items Fulfilled by Nexus --- #}
            {% with nexus_items=vendor_items|filtered_by_fulfillment:'nexus' %}
                {% include "core/vendor/_order_items_table.html" with title=_("Items Fulfilled by Nexus") items=nexus_items %}
            {% endwith %}

            {# --- Items Fulfilled by You (the Vendor) --- #}
            {% with vendor_fulfilled_items=vendor_items|filtered_by_fulfillment:'vendor' %}
                {% include "core/vendor/_order_items_table.html" with title=_("Items Fulfilled by You") items=vendor_fulfilled_items %}
            {% endwith %}

            <div class="mt-4 pt-4 border-top">
                <h5 class="mb-3">{% trans "Order Actions" %}</h5>
                {% if order.status == 'PROCESSING' %}
                    {# Check if there are any vendor-fulfilled physical items #}
                    {% with shippable_items=vendor_items|filtered_by_fulfillment:'vendor'|filtered_by_type:'physical' %}
                    {% if shippable_items %} {# Corrected to use order.pk to match the URL pattern #}
                        <form action="{% url 'core:vendor_mark_order_shipped' order.pk %}" method="post" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-info">
                                <i class="bi bi-truck me-2"></i>{% trans "Mark as Shipped" %}
                            </button>
                        </form>
                    {% endif %}
                    {% endwith %}
                {% elif order.status == 'PENDING' %}
                    <p class="text-muted"><em>{% trans "Actions will be available once the order is processing." %}</em></p>
                {% endif %}
                <a href="{% url 'core:vendor_generate_packing_slip' order.pk %}" target="_blank" class="btn btn-outline-secondary"><i class="bi bi-printer me-2"></i>{% trans "Print Packing Slip" %}</a>
                <form action="{% url 'core:vendor_email_packing_slip' order.pk %}" method="post" class="d-inline ms-2">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-primary" title="{% trans 'Email a PDF of the packing slip to your registered email address.' %}">
                        <i class="bi bi-envelope me-2"></i>{% trans "Email Packing Slip" %}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
{{ block.super }}
{% if show_map and google_maps_api_key and vendor_location_lat and vendor_location_lng and delivery_lat and delivery_lng %}
<script>
    function initVendorOrderDetailMap() {
        console.log("Initializing Vendor Order Detail Map...");
        const pickupLocation = { lat: {{ vendor_location_lat|default:0.0 }}, lng: {{ vendor_location_lng|default:0.0 }} }; // Vendor's location
        const deliveryLocation = { lat: {{ delivery_lat|default:0.0 }}, lng: {{ delivery_lng|default:0.0 }} }; // Customer's location
        if (pickupLocation.lat === 0.0 && pickupLocation.lng === 0.0 && deliveryLocation.lat === 0.0 && deliveryLocation.lng === 0.0) {
            console.warn("Map coordinates are not valid for this order. Map will not be fully initialized.");
            document.getElementById("deliveryMapForVendor").innerHTML = "<p class='text-center p-3'>{% trans 'Map data is currently unavailable for this order.' %}</p>";
            return;
        }

        const map = new google.maps.Map(document.getElementById("deliveryMapForVendor"), {
            // Check if google.maps object is available
            // This check should ideally be before trying to use it.
            // If 'google' is not defined, the script from base.html didn't load.
            // For now, we assume it loads if this block is reached.
            zoom: 12,
            center: pickupLocation, // Center on vendor's location
        });

        new google.maps.Marker({
            position: pickupLocation,
            map: map,
            title: "{% trans 'Your Location (Pickup)' %}",
            label: "P",
             icon: {
                path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#4CAF50", fillOpacity: 1, strokeWeight: 1, strokeColor: "#ffffff"
            }
        });

        new google.maps.Marker({
            position: deliveryLocation,
            map: map,
            title: "{% trans 'Customer Delivery Location' %}",
            label: "D",
            icon: {
                path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#F44336", fillOpacity: 1, strokeWeight: 1, strokeColor: "#ffffff"
            }
        });

        const bounds = new google.maps.LatLngBounds();
        bounds.extend(pickupLocation);
        bounds.extend(deliveryLocation);
        map.fitBounds(bounds);

        google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
            if (map.getZoom() > 15) { map.setZoom(15); }
        });
    }
    window.initMap = initVendorOrderDetailMap; // Override global initMap for this page
</script>
{% endif %}
{% endblock extra_js %}