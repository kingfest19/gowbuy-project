{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% load crispy_forms_tags %}
{% load custom_filters %}

{% block title %}{% trans "Edit Provider Profile & Portfolio" %} - {{ block.super }}{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .edit-profile-page-container {
        background-color: #fff; /* White background for the main content area */
        padding: 2rem;
        border-radius: 0.5rem;
        box-shadow: 0 0.25rem 1rem rgba(0,0,0,0.075); /* Subtle shadow */
        margin-top: 1rem; /* Adjust if base container has enough margin */
        margin-bottom: 2rem;
    }

    .edit-profile-page-container .page-main-title {
        font-size: 2rem; /* Main page title */
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 2rem;
    }

    .profile-section {
        margin-bottom: 2.5rem;
    }

    .profile-section h4 { /* Section titles */
        font-size: 1.5rem;
        font-weight: 500;
        color: #34495e;
        margin-bottom: 1.25rem;
        padding-bottom: 0.6rem;
        border-bottom: 2px solid #e9ecef;
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="edit-profile-page-container"> {# New main wrapper with white background #}
        <div class="row">
            <div class="col-12">
                <h1 class="page-main-title">{% trans "Edit Provider Profile & Portfolio" %}</h1>
            </div>
        </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

        <div class="row">
            <!-- Edit Profile Section -->
            <div class="col-md-6 mb-4 profile-section">
                <h4>{% trans "Edit Your Provider Profile" %}</h4>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ profile_form|crispy }}
                    <div class="d-grid mt-3">
                        <button type="submit" name="submit_profile" class="btn btn-primary">{% trans "Save Profile Changes" %}</button>
                    </div>
                </form>
            </div>

            <!-- Add Portfolio Item Section -->
            <div class="col-md-6 mb-4 profile-section">
                <h4>{% trans "Add New Portfolio Item" %}</h4>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ portfolio_item_form|crispy }}
                    <div class="d-grid mt-3">
                        <button type="submit" name="submit_portfolio_item" class="btn btn-success">{% trans "Add Item to Portfolio" %}</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Manage Existing Portfolio Items Section -->
        <div class="row mt-4">
            <div class="col-12 profile-section">
                <h4>{% trans "Manage Your Portfolio" %}</h4>
                {% if portfolio_items %}
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                        {% for item in portfolio_items %}
                            <div class="col">
                                <div class="card h-100 shadow-sm"> {# Kept card styling for individual portfolio items for now #}
                                    {% if item.image %}
                                        <img src="{{ item.image.url }}" class="card-img-top" alt="{{ item.title|default:'Portfolio image' }}" style="height: 200px; object-fit: cover;">
                                    {% elif item.video_url %}
                                        <div class="ratio ratio-16x9">
                                            {# Basic iframe for YouTube/Vimeo - needs more robust parsing for production #}
                                            {% if "youtube.com/watch?v=" in item.video_url %}
                                                <iframe src="{{ item.video_url|replace:"watch?v=,embed/" }}" title="{{ item.title|default:'Portfolio video' }}" allowfullscreen></iframe>
                                            {% elif "vimeo.com/" in item.video_url %}
                                                 <iframe src="https://player.vimeo.com/video/{{ item.video_url|slice:"-9:" }}" title="{{ item.title|default:'Portfolio video' }}" allowfullscreen></iframe>
                                            {% else %}
                                                <p class="p-3">{% trans "Video preview not available for this URL." %}</p>
                                            {% endif %}
                                    </div>
                                    {% endif %}
                                    <div class="card-body">
                                        <h5 class="card-title">{{ item.title|default:"Untitled Item" }}</h5>
                                        <p class="card-text small">{{ item.description|truncatewords:15 }}</p>
                                    </div>
                                    <div class="card-footer text-center">
                                        <form method="post" action="{% url 'core:delete_portfolio_item' item.id %}" onsubmit="return confirm('{% trans "Are you sure you want to delete this item?" %}');">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-danger">{% trans "Delete" %}</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">{% trans "You haven't added any items to your portfolio yet." %}</p>
                {% endif %}
            </div>
        </div>
    </div> {# End edit-profile-page-container #}
</div> {# End container #}
{% endblock %}

{% block extra_js %}
<script>
    // Optional: Add JS for better UX, e.g., image previews before upload
</script>
{% endblock %}
