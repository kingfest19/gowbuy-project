{% extends "base.html" %}
{% load static i18n crispy_forms_tags %}

{% block extra_css %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>

        body {
            background-color: #ffffffff; /* Light gray background for better contrast */
        }
        .form-container {
            max-width: 900px; /* Good width for forms */
            margin: 0 auto;
            background-color:  #ebe8e8;
            padding: 2rem 2.5rem;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
            border: 1px solid #c7c9cb;
            font-family: "Outfit", sans-serif; /* Consistent font from theme */
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #f0f2f5;
        }

        .page-header h1 {
            font-family: "Poppins", sans-serif; /* Consistent font from theme */
            font-weight: 700;
            color: #1a2533;
            margin-bottom: 0;
        }

        .media-manager-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .media-manager-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important;
        }
        /* Style the switch to be red when checked for clear visual feedback */
        .form-check-input:checked {
            background-color: var(--bs-danger);
            border-color: var(--bs-danger);
        }

        /* --- New Form Styling --- */
        fieldset {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        fieldset:last-of-type {
            margin-bottom: 0;
        }

        legend {
            font-family: "Poppins", sans-serif; /* Consistent font from theme */
            font-size: 1.25rem;
            font-weight: 600;
            color: #1a2533;
            padding: 0;
            width: 100%;
            float: left;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e9ecef;
        }

        /* Custom border for form inputs - softer and more standard */
        .form-container .form-control,
        .form-container .form-select {
            border: 1px solid #ced4da; /* Standard Bootstrap border color */
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        }
        .form-container .form-control:focus,
        .form-container .form-select:focus {
            border-color: #86b7fe; /* Bootstrap's default focus color */
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        /* Style the video list to be more card-like */
        .list-group-item {
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border: 1px solid #dee2e6;
            transition: background-color 0.2s;
        }
        .list-group-item:hover {
            background-color: #f8f9fa;
        }

        /* Style for crispy-forms labels */
        .form-label {
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
        }

        /* Sub-headings within fieldsets, like "Images" and "Videos" */
        fieldset h6 {
            font-family: "Poppins", sans-serif;
            font-weight: 600;
            color: #343a40;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
        }

        /* Custom color for the primary action button */
        .form-container .btn-primary {
            background-color: #474747;
            border-color: #474747;
            font-weight: 500;
        }

        .form-container .btn-outline-secondary {
            background-color: #474747;
            color: #ffffffff;
            border-color: #474747;
        }

        /* Add transitions to main action buttons */
        .btn-outline-secondary:hover {
            background-color: #474747;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .form-container .btn-primary:hover {
            background-color: #383838; /* A darker shade for hover */
            border-color: #383838;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
    </style>
{% endblock extra_css %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="form-container">
        <div class="page-header">
            <div>
                <h1>{{ form_title|default:_("Manage Product") }}</h1>
                <p class="text-muted mb-0">{% if is_update_form %}{% trans "Update the details of your product." %}{% else %}{% trans "Fill out the form to add a new product to your store." %}{% endif %}</p>
            </div>
            <a href="{% url 'core:vendor_product_list' %}" class="btn btn-lg btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>{% trans "Back to Products" %}
            </a>
        </div>
        <form method="post" enctype="multipart/form-data" id="vendorProductForm">
            {% csrf_token %}
            {{ form.media }} {# For any form media like JS for widgets #}

            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {{ form.non_field_errors|join:", " }}
                </div>
            {% endif %}

            <div class="form-body">
                <fieldset>
                    <legend>{% translate "Basic Information" %}</legend>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.name|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.category|as_crispy_field }}
                        </div>
                    </div>

                    <div class="mb-3 position-relative">
                        {% if form.description.errors %}
                            {{ form.description|as_crispy_field }}
                        {% else %}
                            <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                            {{ form.description }}
                        {% endif %}
                        <button type="button" id="enhance-description-btn" class="btn btn-outline-info btn-sm mt-2">
                            <i class="fas fa-magic me-1"></i>{% trans "Enhance with AI" %}
                        </button>
                        <div id="ai-enhancement-status" class="form-text mt-1" style="display: none;"></div>
                        {% if form.description.help_text %}<small class="form-text text-muted">{{ form.description.help_text|safe }}</small>{% endif %}
                    </div>

                     <div class="mb-3">
                        {{ form.keywords_for_ai|as_crispy_field }}
                    </div>
                </fieldset>

                <fieldset class="mt-4">
                    <legend>{% translate "Pricing & Type" %}</legend>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            {{ form.price|as_crispy_field }}
                        </div>
                        <div class="col-md-4 mb-3">
                            {{ form.product_type|as_crispy_field }}
                        </div>
                        <div class="col-md-4 mb-3">
                            {{ form.stock|as_crispy_field }}
                        </div>
                    </div>
                    <div class="mb-3">
                        {{ form.digital_file|as_crispy_field }}
                    </div>
                </fieldset>

                <fieldset class="mt-4">
                    <legend>{% translate "Fulfillment & Delivery" %}</legend>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                             {{ form.fulfillment_method|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.vendor_delivery_fee|as_crispy_field }}
                        </div>
                    </div>
                </fieldset>

                <fieldset class="mt-4">
                    <legend>{% translate "Media Uploads" %}</legend>
                    <div class="mb-3">
                        {{ form.images|as_crispy_field }}
                    </div>

                    <div class="mb-3">
                        {{ form.videos|as_crispy_field }}
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.three_d_model|as_crispy_field }}
                        </div>
                        {% if object.id %} {# Only show AI Generate button for existing products (update form) #}
                        <div class="col-md-6 mb-3 align-self-end">
                            <button type="button" id="aiGenerate3DModelBtn" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-cube me-1"></i>{% translate "AI Generate 3D Model (Simulated)" %}
                            </button>
                            <div id="ai3DStatus" class="form-text mt-1"></div>
                        </div>
                        {% endif %}
                    </div>
                </fieldset>

                {% if is_update_form %}
                <fieldset class="mt-4">
                    <legend>{% translate "Manage Current Media" %}</legend>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6>{% translate "Images" %}</h6>
                        {% if existing_images %}
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="selectAllImagesForDeletion">
                            <label class="form-check-label small" for="selectAllImagesForDeletion">{% translate "Select All" %}</label>
                        </div>
                        {% endif %}
                    </div>
                    {% if existing_images %}
                        <div class="row">
                        {% for img in existing_images %}
                            <div class="col-6 col-sm-4 col-md-3 col-lg-2 mb-4">
                                <div class="card h-100 media-manager-card text-center shadow-sm">
                                    <a href="{{ img.image.url }}" data-bs-toggle="tooltip" title="{% trans 'View full image' %}" target="_blank">
                                        <img src="{{ img.image.url }}" alt="{{ img.alt_text|default:'Product image' }}" class="card-img-top" style="height: 120px; object-fit: cover;">
                                    </a>
                                    <div class="card-footer p-2">
                                        <div class="form-check form-switch d-flex justify-content-center align-items-center">
                                            <input class="form-check-input image-delete-checkbox" type="checkbox" role="switch" name="delete_images" value="{{ img.id }}" id="delete_image_{{ img.id }}">
                                            <label class="form-check-label small ms-2" for="delete_image_{{ img.id }}">
                                                {% translate "Delete" %}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                        </div>
                    {% else %}<p class="text-muted">{% translate "No images uploaded yet." %}</p>{% endif %}

                    <div class="d-flex justify-content-between align-items-center mt-3 mb-2">
                        <h6>{% translate "Videos" %}</h6>
                        {% if existing_videos %}
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="selectAllVideosForDeletion">
                            <label class="form-check-label small" for="selectAllVideosForDeletion">{% translate "Select All" %}</label>
                        </div>
                        {% endif %}
                    </div>
                    {% if existing_videos %}
                        <ul class="list-group">
                        {% for vid in existing_videos %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-video me-2 text-muted"></i>
                                    <a href="{{ vid.video.url }}" target="_blank" title="{{ vid.video.name }}">{{ vid.video.name|truncatechars:40 }}</a>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input video-delete-checkbox" type="checkbox" role="switch" name="delete_videos" value="{{ vid.id }}" id="delete_video_{{ vid.id }}">
                                    <label class="form-check-label small" for="delete_video_{{ vid.id }}">{% translate "Delete" %}</label>
                                </div>
                            </li>
                        {% endfor %}
                        </ul>
                    {% else %}<p class="text-muted">{% translate "No videos uploaded yet." %}</p>{% endif %}

                    {% if object.three_d_model %}
                        <h6 class="mt-3">{% translate "Current 3D Model" %}</h6>
                        <p><i class="fas fa-cube me-2 text-muted"></i><a href="{{ object.three_d_model.url }}" target="_blank">{{ object.three_d_model.name|cut:"products/3d_models/" }}</a></p>
                    {% endif %}
                </fieldset>
                {% endif %}

                <fieldset class="mt-4">
                    <legend>{% translate "Visibility" %}</legend>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.is_active|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.is_featured|as_crispy_field }}
                        </div>
                    </div>
                </fieldset>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <a href="{% url 'core:vendor_product_list' %}" class="btn btn-outline-secondary">{% translate "Cancel" %}</a>
                    <button type="submit" class="btn btn-primary">
                        {% if is_update_form %}{% translate "Save Changes" %}{% else %}{% translate "Create Product" %}{% endif %}
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // AI Description Enhancement
    const enhanceBtn = document.getElementById('enhance-description-btn');
    const descriptionTextarea = document.getElementById('{{ form.description.id_for_label }}'); // Ensure this ID is correct
    const productNameField = document.getElementById('{{ form.name.id_for_label }}'); // Ensure this ID is correct
    const categorySelectField = document.getElementById('{{ form.category.id_for_label }}'); // Ensure this ID is correct
    const keywordsField = document.getElementById('{{ form.keywords_for_ai.id_for_label }}'); // Ensure this ID is correct
    const statusDiv = document.getElementById('ai-enhancement-status');

    if (enhanceBtn && descriptionTextarea && productNameField && categorySelectField) {
        enhanceBtn.addEventListener('click', function() {
            const productName = productNameField.value;
            const categoryName = categorySelectField.options[categorySelectField.selectedIndex].text;
            const currentDescription = descriptionTextarea.value;
            const keywords = keywordsField ? keywordsField.value : "";

            if (!productName.trim() || !categoryName.trim() || categorySelectField.value === "") {
                statusDiv.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>{% trans 'Please enter product name and select a category first.' %}</span>`;
                statusDiv.style.display = 'block';
                return;
            }

            statusDiv.innerHTML = `<span class="text-info"><i class="fas fa-spinner fa-spin me-1"></i>{% trans 'Enhancing description...' %}</span>`;
            statusDiv.style.display = 'block';
            enhanceBtn.disabled = true;
            enhanceBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>{% trans "Enhancing..." %}';

            fetch("{% url 'core:ajax_enhance_product_description' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    product_name: productName,
                    category_name: categoryName,
                    current_description: currentDescription,
                    keywords: keywords
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(errData.error || `{% trans 'Server responded with status:' %} ${response.status}`);
                    }).catch(() => {
                        throw new Error(`{% trans 'Server responded with status:' %} ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.enhanced_description) {
                    descriptionTextarea.value = data.enhanced_description;
                    statusDiv.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>{% trans 'Description enhanced successfully!' %}</span>`;
                } else if (data.error) {
                    statusDiv.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>{% trans 'Error:' %} ${data.error}</span>`;
                }
            })
            .catch(error => {
                console.error('Error enhancing description:', error);
                statusDiv.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>{% trans 'An error occurred:' %} ${error.message}</span>`;
            })
            .finally(() => {
                enhanceBtn.disabled = false;
                enhanceBtn.innerHTML = '<i class="fas fa-magic me-1"></i>{% trans "Enhance with AI" %}';
                setTimeout(() => { statusDiv.style.display = 'none'; statusDiv.textContent = ''; }, 7000);
            });
        });
    } else {
        console.warn("AI description enhancement button or required form fields not found. Ensure IDs are correct.");
    }

    // AI 3D Model Generation
    const aiGenerate3DBtn = document.getElementById('aiGenerate3DModelBtn');
    const ai3DStatusDiv = document.getElementById('ai3DStatus');
    const productId = "{{ object.id|default:'' }}";

    if (aiGenerate3DBtn && productId) {
        aiGenerate3DBtn.addEventListener('click', function () {
            ai3DStatusDiv.innerHTML = '<span class="text-info"><i class="fas fa-spinner fa-spin me-1"></i>{% translate "Initiating 3D model generation..." %}</span>';
            aiGenerate3DBtn.disabled = true;
            aiGenerate3DBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>{% trans "Initiating..." %}';


            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("{% url 'core:ajax_generate_3d_model' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    product_id: productId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    ai3DStatusDiv.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>${data.message}</span>`;
                } else {
                    ai3DStatusDiv.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>{% translate "Error" %}: ${data.error || '{% translate "Unknown error." %}'}</span>`;
                }
            })
            .catch(error => {
                console.error('Error initiating 3D model generation:', error);
                ai3DStatusDiv.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>{% translate "Request failed. Please try again." %}</span>';
            })
            .finally(() => {
                // Keep button disabled to prevent multiple requests for simulation
                // aiGenerate3DBtn.disabled = false;
                // aiGenerate3DBtn.innerHTML = '<i class="fas fa-cube me-1"></i>{% translate "AI Generate 3D Model (Simulated)" %}';
                // Optionally hide status after a while
                // setTimeout(() => { ai3DStatusDiv.textContent = ''; }, 10000);
            });
        });
    }

    // --- START: Select All for Deletion ---
    const selectAllImagesCheckbox = document.getElementById('selectAllImagesForDeletion');
    if (selectAllImagesCheckbox) {
        selectAllImagesCheckbox.addEventListener('change', function() {
            const imageDeleteCheckboxes = document.querySelectorAll('.image-delete-checkbox');
            imageDeleteCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }

    const selectAllVideosCheckbox = document.getElementById('selectAllVideosForDeletion');
    if (selectAllVideosCheckbox) {
        selectAllVideosCheckbox.addEventListener('change', function() {
            const videoDeleteCheckboxes = document.querySelectorAll('.video-delete-checkbox');
            videoDeleteCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }
    // --- END: Select All for Deletion ---
});
</script>
{% endblock extra_js %}
