{% extends "core/vendor_dashboard_base.html" %} {% comment %} Adjust if your base template is different {% endcomment %}
{% load static i18n crispy_forms_tags %}

{% block vendor_content %}
<div class="container-fluid mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="card-title mb-0">{{ form_title|default:_("Manage Product") }}</h4>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" id="vendorProductForm">
                {% csrf_token %}
                {{ form.media }} {# For any form media like JS for widgets #}

                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ form.non_field_errors|join:", " }}
                    </div>
                {% endif %}

                <fieldset>
                    <legend class="h5">{% translate "Basic Information" %}</legend>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.name|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.category|as_crispy_field }}
                        </div>
                    </div>

                    <div class="mb-3 position-relative">
                        {% if form.description.errors %}
                            {{ form.description|as_crispy_field }}
                        {% else %}
                            <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                            {{ form.description }}
                        {% endif %}
                        <button type="button" id="enhance-description-btn" class="btn btn-outline-info btn-sm mt-2">
                            <i class="fas fa-magic me-1"></i>{% trans "Enhance with AI" %}
                        </button>
                        <div id="ai-enhancement-status" class="form-text mt-1" style="display: none;"></div>
                        {% if form.description.help_text %}<small class="form-text text-muted">{{ form.description.help_text|safe }}</small>{% endif %}
                    </div>

                     <div class="mb-3">
                        {{ form.keywords_for_ai|as_crispy_field }}
                    </div>
                </fieldset>

                <fieldset class="mt-4">
                    <legend class="h5">{% translate "Pricing & Type" %}</legend>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            {{ form.price|as_crispy_field }}
                        </div>
                        <div class="col-md-4 mb-3">
                            {{ form.product_type|as_crispy_field }}
                        </div>
                        <div class="col-md-4 mb-3">
                            {{ form.stock|as_crispy_field }}
                        </div>
                    </div>
                    <div class="mb-3">
                        {{ form.digital_file|as_crispy_field }}
                    </div>
                </fieldset>

                <fieldset class="mt-4">
                    <legend class="h5">{% translate "Fulfillment & Delivery" %}</legend>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                             {{ form.fulfillment_method|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.vendor_delivery_fee|as_crispy_field }}
                        </div>
                    </div>
                </fieldset>

                <fieldset class="mt-4">
                    <legend class="h5">{% translate "Media Uploads" %}</legend>
                    <div class="mb-3">
                        <label for="id_images" class="form-label">{% translate "Product Images" %}</label>
                        <input type="file" name="images" multiple class="form-control" id="id_images">
                        {% if form.images.help_text %}<small class="form-text text-muted">{{ form.images.help_text }}</small>{% endif %}
                        {% for error in form.images.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </div>

                    <div class="mb-3">
                        <label for="id_videos" class="form-label">{% translate "Product Videos" %}</label>
                        <input type="file" name="videos" multiple class="form-control" id="id_videos">
                        {% if form.videos.help_text %}<small class="form-text text-muted">{{ form.videos.help_text }}</small>{% endif %}
                        {% for error in form.videos.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.three_d_model|as_crispy_field }}
                        </div>
                        {% if object.id %} {# Only show AI Generate button for existing products (update form) #}
                        <div class="col-md-6 mb-3 align-self-end">
                            <button type="button" id="aiGenerate3DModelBtn" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-cube me-1"></i>{% translate "AI Generate 3D Model (Simulated)" %}
                            </button>
                            <div id="ai3DStatus" class="form-text mt-1"></div>
                        </div>
                        {% endif %}
                    </div>
                </fieldset>

                {% if is_update_form %}
                <fieldset class="mt-4">
                    <legend class="h5">{% translate "Current Media" %}</legend>
                    <h6>{% translate "Images" %}</h6>
                    {% if existing_images %}
                        <div class="d-flex flex-wrap mb-3">
                        {% for img in existing_images %}
                            <div class="m-1 position-relative">
                                <img src="{{ img.image.url }}" alt="{{ img.alt_text|default:'Product image' }}" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
                                {% comment %} Optional: Add delete button for existing images here if needed {% endcomment %}
                            </div>
                        {% endfor %}
                        </div>
                    {% else %}<p class="text-muted">{% translate "No images uploaded yet." %}</p>{% endif %}

                    <h6 class="mt-3">{% translate "Videos" %}</h6>
                    {% if existing_videos %}
                        <ul class="list-unstyled">
                        {% for vid in existing_videos %}
                            <li><a href="{{ vid.video.url }}" target="_blank">{{ vid.title|default_if_none:vid.video.name }}</a></li>
                        {% endfor %}
                        </ul>
                    {% else %}<p class="text-muted">{% translate "No videos uploaded yet." %}</p>{% endif %}

                    {% if object.three_d_model %}
                        <h6 class="mt-3">{% translate "Current 3D Model" %}</h6>
                        <p><a href="{{ object.three_d_model.url }}" target="_blank">{{ object.three_d_model.name|cut:"products/3d_models/" }}</a></p>
                    {% endif %}
                </fieldset>
                {% endif %}

                <fieldset class="mt-4">
                    <legend class="h5">{% translate "Visibility" %}</legend>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.is_active|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.is_featured|as_crispy_field }}
                        </div>
                    </div>
                </fieldset>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <a href="{% url 'core:vendor_product_list' %}" class="btn btn-outline-secondary">{% translate "Cancel" %}</a>
                    <button type="submit" class="btn btn-primary">
                        {% if is_update_form %}{% translate "Save Changes" %}{% else %}{% translate "Create Product" %}{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock vendor_content %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // AI Description Enhancement
    const enhanceBtn = document.getElementById('enhance-description-btn');
    const descriptionTextarea = document.getElementById('{{ form.description.id_for_label }}'); // Ensure this ID is correct
    const productNameField = document.getElementById('{{ form.name.id_for_label }}'); // Ensure this ID is correct
    const categorySelectField = document.getElementById('{{ form.category.id_for_label }}'); // Ensure this ID is correct
    const keywordsField = document.getElementById('{{ form.keywords_for_ai.id_for_label }}'); // Ensure this ID is correct
    const statusDiv = document.getElementById('ai-enhancement-status');

    if (enhanceBtn && descriptionTextarea && productNameField && categorySelectField) {
        enhanceBtn.addEventListener('click', function() {
            const productName = productNameField.value;
            const categoryName = categorySelectField.options[categorySelectField.selectedIndex].text;
            const currentDescription = descriptionTextarea.value;
            const keywords = keywordsField ? keywordsField.value : "";

            if (!productName.trim() || !categoryName.trim() || categorySelectField.value === "") {
                statusDiv.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>{% trans 'Please enter product name and select a category first.' %}</span>`;
                statusDiv.style.display = 'block';
                return;
            }

            statusDiv.innerHTML = `<span class="text-info"><i class="fas fa-spinner fa-spin me-1"></i>{% trans 'Enhancing description...' %}</span>`;
            statusDiv.style.display = 'block';
            enhanceBtn.disabled = true;
            enhanceBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>{% trans "Enhancing..." %}';

            fetch("{% url 'core:ajax_enhance_product_description' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    product_name: productName,
                    category_name: categoryName,
                    current_description: currentDescription,
                    keywords: keywords
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(errData.error || `{% trans 'Server responded with status:' %} ${response.status}`);
                    }).catch(() => {
                        throw new Error(`{% trans 'Server responded with status:' %} ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.enhanced_description) {
                    descriptionTextarea.value = data.enhanced_description;
                    statusDiv.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>{% trans 'Description enhanced successfully!' %}</span>`;
                } else if (data.error) {
                    statusDiv.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>{% trans 'Error:' %} ${data.error}</span>`;
                }
            })
            .catch(error => {
                console.error('Error enhancing description:', error);
                statusDiv.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>{% trans 'An error occurred:' %} ${error.message}</span>`;
            })
            .finally(() => {
                enhanceBtn.disabled = false;
                enhanceBtn.innerHTML = '<i class="fas fa-magic me-1"></i>{% trans "Enhance with AI" %}';
                setTimeout(() => { statusDiv.style.display = 'none'; statusDiv.textContent = ''; }, 7000);
            });
        });
    } else {
        console.warn("AI description enhancement button or required form fields not found. Ensure IDs are correct.");
    }

    // AI 3D Model Generation
    const aiGenerate3DBtn = document.getElementById('aiGenerate3DModelBtn');
    const ai3DStatusDiv = document.getElementById('ai3DStatus');
    const productId = "{{ object.id|default:'' }}";

    if (aiGenerate3DBtn && productId) {
        aiGenerate3DBtn.addEventListener('click', function () {
            ai3DStatusDiv.innerHTML = '<span class="text-info"><i class="fas fa-spinner fa-spin me-1"></i>{% translate "Initiating 3D model generation..." %}</span>';
            aiGenerate3DBtn.disabled = true;
            aiGenerate3DBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>{% trans "Initiating..." %}';


            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("{% url 'core:ajax_generate_3d_model' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    product_id: productId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    ai3DStatusDiv.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>${data.message}</span>`;
                } else {
                    ai3DStatusDiv.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>{% translate "Error" %}: ${data.error || '{% translate "Unknown error." %}'}</span>`;
                }
            })
            .catch(error => {
                console.error('Error initiating 3D model generation:', error);
                ai3DStatusDiv.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>{% translate "Request failed. Please try again." %}</span>';
            })
            .finally(() => {
                // Keep button disabled to prevent multiple requests for simulation
                // aiGenerate3DBtn.disabled = false;
                // aiGenerate3DBtn.innerHTML = '<i class="fas fa-cube me-1"></i>{% translate "AI Generate 3D Model (Simulated)" %}';
                // Optionally hide status after a while
                // setTimeout(() => { ai3DStatusDiv.textContent = ''; }, 10000);
            });
        });
    }
});
</script>
{% endblock extra_js %}
