 {% extends "base.html" %}
 {% load static i18n humanize query_params %}
 
 {% block title %}{% trans "Client Reviews" %} - {% trans "Provider Dashboard" %}{% endblock %}
 
 {% block extra_css %}
     {{ block.super }}
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
     <style>
         .list-container {
             max-width: 1200px;
             margin: 0 auto;
             background-color: #ebe8e8;
             padding: 2rem 2.5rem;
             border-radius: 12px;
             box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
             border: 1px solid #959aa0; /* Softer border */
         }
 
         .page-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             flex-wrap: wrap;
             gap: 1rem;
             padding: 1.5rem;
             margin-bottom: 2.5rem;
             border-radius: 8px;
             background-color: #ffffff; /* White background */
             border-left: 5px solid #323232ff; /* Prominent black left border */
             border: 1px solid #c7c9cb; /* Subtle border for separation */
         }
 
         .page-header h1 {
             font-weight: 600;
             color: #323232ff; /* Black text for contrast */
             margin-bottom: 0;
         }
 
         .page-header .btn-outline-secondary {
             background-color: #474747;
             color: #ffffff;
             border-color: #474747;
         }
         .page-header .btn-outline-secondary:hover {
             background-color: #383838; /* A darker shade for hover */
             border-color: #383838;
         }
 
         .card {
             background-color: #fff;
             border-radius: 8px;
             box-shadow: 0 2px 8px rgba(0,0,0,0.06);
             transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
             border: 1px solid #f0f2f5;
         }
         
         .card:hover {
             transform: translateY(-3px);
             box-shadow: 0 5px 15px rgba(0,0,0,0.1);
         }
 
         .rating-stars .fa-star { color: #ffc107; } /* Gold for filled stars */
         .rating-stars .fa-star-o { color: #e4e5e9; } /* Light grey for empty stars */
 
         .filter-bar {
             background-color: #f8f9fa;
             padding: 1rem;
             border-radius: 8px;
             margin-bottom: 2rem;
             border: 1px solid #c7c9cb; /* Softer border */
         }
         .btn-dark {
             background-color: #474747;
             border-color: #474747;
         }
         .btn-dark:hover {
             background-color: #383838; /* A darker shade for hover */
             border-color: #383838;
         }
     </style>
 {% endblock extra_css %}
 
 {% block content %}
 <div class="container mt-5 mb-5">
     <div class="list-container">
         <div class="page-header">
             <div>
                 <h1>{% trans "Client Reviews" %}</h1>
                 {% if average_rating %}
                     <p class="text-muted mb-0">
                         {% blocktrans with rating=average_rating|floatformat:1 count=total_reviews %}
                             Average Rating: {{ rating }}/5 from {{ count }} review{{ count|pluralize }}
                         {% endblocktrans %}
                     </p>
                 {% endif %}
             </div>
             <a href="{% url 'core:service_provider_dashboard' %}" class="btn btn-lg btn-outline-secondary">
                 <i class="bi bi-arrow-left me-2"></i>{% trans "Back to Dashboard" %}
             </a>
         </div>
 
         <!-- Filter Bar -->
         <div class="filter-bar">
             <form method="get" action="">
                 <div class="row g-3 align-items-center">
                     <div class="col-md">
                         <div class="input-group">
                             <input type="text" name="q" class="form-control" placeholder="{% trans 'Search by user, service, or review...' %}" value="{{ search_query|default:'' }}">
                             <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
                         </div>
                     </div>
                     <div class="col-md-auto">
                         <div class="btn-group" role="group" aria-label="Rating filter">
                             <a href="?{% query_transform rating='' page=1 %}" class="btn {% if not current_rating %}btn-dark{% else %}btn-outline-secondary{% endif %}">{% trans "All" %}</a>
                             {% for i in "54321" %}
                             <a href="?{% query_transform rating=i page=1 %}" class="btn {% if current_rating == i %}btn-dark{% else %}btn-outline-secondary{% endif %}">
                                 {{ i }} <i class="fa fa-star text-warning"></i>
                             </a>
                             {% endfor %}
                         </div>
                     </div>
                 </div>
             </form>
         </div>
 
         {% if reviews %}
             {% for review in reviews %}
                 <div class="card mb-3">
                     <div class="card-body">
                         <div class="d-flex justify-content-between">
                             <h5 class="card-title mb-1">{% trans "Review by:" %} {{ review.user.get_full_name|default:review.user.username }}</h5>
                             <small class="text-muted">{{ review.created_at|naturaltime }}</small>
                         </div>
                         <p class="mb-1 small"><strong>{% trans "Service" %}:</strong> <a href="{{ review.service.get_absolute_url }}">{{ review.service.title }}</a></p>
                         <div class="rating-stars mb-2">
                             {% for i in "12345" %}
                                 <i class="fa {% if review.rating >= i|add:0 %}fa-star{% else %}fa-star-o{% endif %}"></i>
                             {% endfor %}
                             <span class="ms-1">({{ review.rating }}/5)</span>
                         </div>
                         <p class="card-text">{{ review.review|linebreaksbr }}</p>
 
                         {% if review.reply %}
                             <div class="vendor-reply mt-3 p-3 bg-light rounded border">
                                 <h6 class="fw-bold mb-1">{% trans "Your Reply" %} <small class="text-muted fw-normal">({{ review.replied_at|naturaltime }})</small></h6>
                                 <p class="mb-0">{{ review.reply|linebreaksbr }}</p>
                             </div>
                         {% endif %}
 
                         <div class="mt-3">
                             <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#replyModal-{{ review.id }}">
                                 {% if review.reply %}<i class="bi bi-pencil-square me-1"></i> {% trans "Edit Reply" %}{% else %}<i class="bi bi-reply-fill me-1"></i> {% trans "Reply" %}{% endif %}
                             </button>
                         </div>
                     </div>
                 </div>
 
                 <!-- Reply Modal -->
                 <div class="modal fade" id="replyModal-{{ review.id }}" tabindex="-1" aria-labelledby="replyModalLabel-{{ review.id }}" aria-hidden="true">
                     <div class="modal-dialog modal-dialog-centered">
                         <div class="modal-content">
                             <form action="{% url 'core:service_provider_review_reply' pk=review.id %}" method="post">
                                 {% csrf_token %}
                                 <div class="modal-header">
                                     <h5 class="modal-title" id="replyModalLabel-{{ review.id }}">{% trans "Reply to Review" %}</h5>
                                     <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                 </div>
                                 <div class="modal-body">
                                     <p><strong>{% trans "Review by:" %}</strong> {{ review.user.get_full_name|default:review.user.username }}</p>
                                     <blockquote class="blockquote small bg-light p-2 rounded">"{{ review.review|truncatewords:30 }}"</blockquote>
                                     <div class="mb-3">
                                         <label for="reply-text-{{ review.id }}" class="form-label">{% trans "Your Reply" %}</label>
                                         <textarea name="reply" class="form-control" id="reply-text-{{ review.id }}" rows="4" placeholder="{% trans 'Write your public reply here...' %}" required>{{ review.reply|default:'' }}</textarea>
                                     </div>
                                 </div>
                                 <div class="modal-footer">
                                     <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                                     <button type="submit" class="btn btn-primary">{% trans "Submit Reply" %}</button>
                                 </div>
                             </form>
                         </div>
                     </div>
                 </div>
             {% endfor %}
             {% include "core/snippets/pagination_snippet.html" with page_obj=reviews %}
         {% else %}
             <div class="text-center py-5">
                 <i class="bi bi-chat-square-quote" style="font-size: 3rem; color: #6c757d;"></i>
                 <h4 class="mt-3">{% trans "No Reviews Found" %}</h4>
                 {% if current_rating or search_query %}
                     <p class="text-muted">{% trans "No reviews match your filter or search criteria. Try adjusting them." %}</p>
                     <a href="{% url 'core:service_provider_review_list' %}" class="btn btn-secondary btn-sm">{% trans "Clear Filters" %}</a>
                 {% else %}
                     <p class="text-muted">{% trans "You have not received any reviews yet." %}</p>
                 {% endif %}
             </div>
         {% endif %}
     </div>
 </div>
 {% endblock %}