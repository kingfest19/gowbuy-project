{% extends "base.html" %}
{% load static i18n humanize crispy_forms_tags %}

{% block title %}{{product.name}} - NEXUS{% endblock title %}

{% block extra_css %}
{# We are using Drift's CSS for the Amazon-style zoom #}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/drift-zoom/1.3.1/drift-basic.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
{# Font Awesome for the video play icon on thumbnails #}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
  .main-image-wrapper {
    position: relative; /* Container for the main image and the zoom pane */
  }

  .media-display-container {
    position: relative;
    display: block;
    /* border: 1px solid #eee; */ /* Removed border as requested */
    /* background-color: #f8f9fa; */ /* Removed background color as requested */
    min-height: 400px; /* Ensure container has a height */
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Styling for the zoom pane that appears on hover */
  .drift-zoom-pane {
    border: 1px solid #ddd;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    z-index: 1050; /* Ensure it's above other content */
  }

  /* Thumbnail Gallery Styles */
  .thumbnail-gallery {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .thumbnail-item-wrapper {
    position: relative;
    cursor: pointer;
  }
  .thumbnail-item {
    border: 2px solid transparent;
    transition: border-color 0.2s;
    padding: 2px;
    border-radius: 4px;
    width: 80px;
    height: 80px;
    object-fit: cover;
  }
  .thumbnail-item:hover,
  .thumbnail-item.active {
    border-color: #007bff; /* Primary color for active thumbnail */
  }
  .video-play-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2rem;
    color: rgba(255, 255, 255, 0.8);
    pointer-events: none; /* Allows clicks to go to the image behind it */
    text-shadow: 0 0 8px rgba(0,0,0,0.5);
  }

  /* Star Rating Styles */
  .rating-stars {
    display: inline-block;
    direction: rtl; /* Right to left to make stars fill from left */
  }
  .rating-stars input[type="radio"] {
    display: none;
  }
  .rating-stars label {
    color: #ddd;
    cursor: pointer;
    font-size: 1.5rem;
    padding: 0 0.1em;
    transition: color 0.2s;
  }
  .rating-stars label:hover,
  .rating-stars label:hover ~ label,
  .rating-stars input[type="radio"]:checked ~ label {
    color: #ffc107; /* Bootstrap warning color */
  }

  /* --- START: AI Tool Button Styles --- */
  .ai-tools-overlay {
    position: absolute;
    bottom: 4px; /* Position at the bottom of the wrapper */
    left: 4px;
    right: 4px;
    display: flex;
    justify-content: space-around;
    background: rgba(0, 0, 0, 0.6);
    border-bottom-left-radius: 4px;
    border-bottom-right-radius: 4px;
    padding: 2px 0;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
    pointer-events: none; /* Initially not clickable */
  }

  .thumbnail-item-wrapper:hover .ai-tools-overlay {
    opacity: 1;
    pointer-events: auto; /* Clickable on hover */
  }

  /* Modern Card Shadow for Main Image */
  .main-image-wrapper {
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08), 0 1.5px 4px rgba(0,0,0,0.04);
    border-radius: 12px;
    background: #fff;
    margin-bottom: 1.5rem;
    border: 1px solid #040404ff;
  }
  /* Page Background and Container */
  body {
    background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
    min-height: 100vh;
  }

  /* Enhanced Product Description Styles */
  #product-description {
    border: 1.5px solid #e3e6ea;
    border-radius: 10px;
    background: #f8f9fa;
    padding: 18px 16px;
    font-size: 1.08rem;
    color: #333;
    box-shadow: 0 1px 8px rgba(0,0,0,0.04);
    transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
    margin-bottom: 1.5rem;
  }
  #product-description:hover {
    border-color: #007bff;
    background: #e3f2fd;
    box-shadow: 0 4px 16px rgba(0,123,255,0.09);
  }
  .container {
    background: rgba(255,255,255,0.97);
    border-radius: 18px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.09);
    padding: 32px 24px;
    margin-bottom: 32px;
    transition: box-shadow 0.3s;
    border: 1px solid #000000ff;
  }
  .container:hover {
    box-shadow: 0 16px 48px rgba(0,123,255,0.12);
  }

  /* Card Hover Effect */
  .card {
    transition: transform 0.18s, box-shadow 0.18s;
    border: 1px solid #000000ff;
  }
  .card:hover {
    transform: translateY(-4px) scale(1.03);
    box-shadow: 0 12px 32px rgba(0,123,255,0.13);
    border: 1.5px solid #00bfff;
  }

  /* Button Hover Effects */
  .btn-primary, .btn-outline-primary {
    transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    border: 1px solid #040034ff;  
  }
  .btn-primary:hover {
    background: linear-gradient(90deg, #007bff 60%, #00bfff 100%);
    color: #fff;
    box-shadow: 0 2px 12px rgba(0,123,255,0.18);
  }
  .btn-outline-primary:hover {
    background: #e3f2fd;
    color: #007bff;
    box-shadow: 0 2px 12px rgba(0,123,255,0.12);
  }

  /* Tab Hover */
  .nav-tabs .nav-link:hover {
    background: #e3f2fd;
    color: #007bff;
  }

  /* Table Row Hover */
  .table-striped > tbody > tr:hover {
    background-color: #e3f2fd;
    transition: background 0.2s;
  }

  /* Review Section Hover */
  .d-flex.mb-3.pb-3.border-bottom:hover {
    background: #e3f2fd;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,123,255,0.07);
    transition: background 0.2s, box-shadow 0.2s;
  }

  /* Thumbnail Hover Enhancement */
  .thumbnail-item-wrapper:hover .thumbnail-item {
    border-color: #00bfff;
    box-shadow: 0 4px 16px rgba(0,123,255,0.18);
    transform: scale(1.08);
    transition: transform 0.18s, box-shadow 0.18s, border-color 0.18s;
  }

  /* Main Image Hover */
  .main-image-wrapper:hover {
    box-shadow: 0 8px 32px rgba(0,123,255,0.13), 0 2px 8px rgba(0,0,0,0.06);
    transition: box-shadow 0.2s;
  }

  /* 3D Viewer Hover */
  .product-3d-viewer:hover {
    box-shadow: 0 8px 32px rgba(0,123,255,0.11);
    background: linear-gradient(135deg, #e3f2fd 80%, #e3e6ea 100%);
    transition: box-shadow 0.2s, background 0.2s;
  }
  /* Modern Card Shadow for 3D Viewer */
  .product-3d-viewer {
    background: linear-gradient(135deg, #f8f9fa 80%, #e3e6ea 100%);
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.07);
    border-radius: 12px;
  }

  /* Modern Card for Related Products */
  .card {
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    transition: box-shadow 0.2s;
  }
  .card:hover {
    box-shadow: 0 6px 24px rgba(0,0,0,0.12);
  }

  /* Modern Buttons */
  .btn-primary, .btn-outline-primary {
    border-radius: 8px;
    font-weight: 500;
    letter-spacing: 0.02em;
    box-shadow: 0 1px 4px rgba(0,123,255,0.08);
  }
  .btn-primary:focus, .btn-outline-primary:focus {
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.15);
  }

  /* Modern Tabs */
  .nav-tabs .nav-link {
    border-radius: 8px 8px 0 0;
    font-weight: 500;
    background: #f8f9fa;
    margin-right: 2px;
    transition: background 0.2s;
  }
  .nav-tabs .nav-link.active {
    background: #fff;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.04);
  }

  /* Modern Table */
  .table-striped > tbody > tr:nth-of-type(odd) {
    background-color: #f4f6fa;
  }
  .table {
    border-radius: 8px;
    overflow: hidden;
  }

  /* Modern Review Section */
  .border-bottom {
    border-bottom: 1.5px solid #e3e6ea !important;
  }
  .review-user {
    font-weight: 600;
    color: #007bff;
  }
  .rating-stars label {
    font-size: 1.7rem;
    padding: 0 0.08em;
  }

  /* Modern Thumbnail Gallery */
  .thumbnail-gallery {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 10px 8px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.04);
  }
  .thumbnail-item {
    box-shadow: 0 1px 6px rgba(0,0,0,0.07);
    border-radius: 8px;
    transition: box-shadow 0.2s, border-color 0.2s;
  }
  .thumbnail-item:hover,
  .thumbnail-item.active {
    box-shadow: 0 2px 12px rgba(0,123,255,0.12);
    border-color: #00bfff;
  }

  /* Modern Form Inputs */
  .form-label {
    font-weight: 500;
    color: #495057;
  }
  .form-control, .form-select {
    border-radius: 8px;
    border: 1.5px solid #e3e6ea;
    transition: border-color 0.2s;
  }
  .form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.15rem rgba(0,123,255,0.08);
  }

  /* Modern Alert */
  .alert {
    border-radius: 8px;
    box-shadow: 0 1px 8px rgba(0,0,0,0.04);
  }

  /* Modern Progress Bar for 3D Viewer */
  .product-3d-viewer .progress-bar {
    background: #e3e6ea;
    border-radius: 8px;
    height: 8px;
  }
  .product-3d-viewer .update-bar {
    background: linear-gradient(90deg, #007bff 0%, #00bfff 100%);
    border-radius: 8px;
    height: 8px;
  }
  .ai-tool-btn {
    background: none;
    border: none;
    color: white;
    font-size: 0.9rem;
    cursor: pointer;
    padding: 2px 4px;
    display: flex;
    align-items: center;
    gap: 3px;
  }
  .ai-tool-btn:hover {
    color: #00bfff; /* Deep sky blue for hover */
  }
  .ai-tool-btn .spinner-border {
      width: 0.8rem;
      height: 0.8rem;
  }
  /* --- END: AI Tool Button Styles --- */
</style>
{% endblock extra_css %}

{% block content %}
<div class="container mt-5">
  <div class="row">
    <div class="col-lg-6">
      {% if request.user.is_authenticated and product.vendor == request.user.vendor_profile %}
        <div class="vendor-options alert alert-info mt-3">
          <p class="mb-0 small">{% trans "As this product's vendor, you can edit it to use AI image enhancement tools." %}</p>
          <a href="{% url 'core:vendor_product_update' pk=product.pk %}" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-edit"></i> {% trans "Edit Product" %}
          </a>
          <form id="enhance-description-form" method="post" action="{% url 'core:ajax_enhance_product_description' %}" class="d-inline">
              {% csrf_token %}
              <input type="hidden" name="product_id" value="{{ product.id }}">
              <button id="enhance-description-btn" type="submit" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-magic"></i> {% trans "Enhance Description (AI)" %}
              </button>
          </form>
        </div>
      {% endif %}
      <div class="main-image-wrapper">
        <!-- This area will be populated by JavaScript -->
        <div id="media-display-area" class="media-display-container">
            {# Fallback for when JS is disabled or no media exists #}
            <noscript>
                {% with first_media=media_gallery.0 %}
                    {% if first_media.type == 'image' %}
                        <img src="{{ first_media.url }}" class="img-fluid rounded" alt="{{ product.name }}">
                    {% endif %}
                {% endwith %}
            </noscript>
            {% if not media_gallery %}
                <img src="{% static 'assets/img/placeholder.png' %}" class="img-fluid rounded" alt="{{ product.name }}">
            {% endif %}
        </div>
        <!-- This div is where the zoomed image will appear for the magnifier -->
        <div class="detail-pane"></div>
      </div>

      <!-- Thumbnail Gallery -->
      {% if media_gallery|length > 1 %}
      <div class="thumbnail-gallery d-flex justify-content-start mt-3">
        {% for media in media_gallery %}
          <div class="thumbnail-item-wrapper">
            <img src="{{ media.thumbnail_url }}"
                 alt="{{ product.name }} thumbnail {{ forloop.counter }}"
                 class="thumbnail-item {% if forloop.first %}active{% endif %}"
                 data-media-type="{{ media.type }}"
                 data-large-src="{{ media.url }}">
            {% if media.type == 'video' %}
              <i class="fas fa-play video-play-icon"></i>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    <div class="col-lg-6">
      <h1>{{ product.name }}</h1>
      <p class="text-muted">{{ product.category }}</p>
      {% if product.vendor %}
      <p class="mb-2">
          {% trans "Sold by:" %} 
          <a href="{{ product.vendor.get_absolute_url }}">{{ product.vendor.name }}</a>
          {% if product.vendor.is_verified %}
              <i class="fas fa-check-circle text-success" title="{% trans 'Verified Vendor' %}"></i>
          {% endif %}
      </p>
      {% endif %}
      <h2 class="mb-4">GH₵{{ product.price }}</h2>
      <p id="product-description">{{ product.description }}</p>
      <div class="d-flex flex-wrap align-items-center gap-2 mb-4">
        <form action="{% url 'core:add_to_cart' product.id %}" method="post" class="flex-grow-1">
          {% csrf_token %}
          <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="bi bi-cart-plus"></i> {% trans "Add to Cart" %}
            </button>
          </div>
        </form>

        {% if product.vendor %}
          {% if request.user.is_authenticated %}
              {% if request.user != product.vendor.user %}
                  <a href="{% url 'core:start_conversation' product_id=product.id %}" class="btn btn-outline-secondary btn-lg">
                      <i class="fas fa-comments"></i> {% trans "Contact Vendor" %}
                  </a>
              {% endif %}
          {% else %}
              <a href="{% url 'authapp:signin' %}?next={{ request.path }}" class="btn btn-outline-secondary btn-lg">
                  <i class="fas fa-comments"></i> {% trans "Login to Contact Vendor" %}
              </a>
          {% endif %}
        {% endif %}
        </div>
    </div>
  </div>

  <div class="row mt-5">
    <div class="col">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="specification-tab" data-bs-toggle="tab" data-bs-target="#specification" type="button" role="tab" aria-controls="specification" aria-selected="true">{% trans "Specification" %}</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab" aria-controls="reviews" aria-selected="false">{% trans "Reviews" %}</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="qa-tab" data-bs-toggle="tab" data-bs-target="#qa" type="button" role="tab" aria-controls="qa" aria-selected="false">{% trans "Questions & Answers" %}</button>
        </li>
      </ul>
      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="specification" role="tabpanel" aria-labelledby="specification-tab">
          <table class="table table-striped mt-3">
            <tbody>
              {% for spec_name, spec_value in product.get_specifications.items %}
              <tr>
                <td><strong>{{ spec_name }}</strong></td>
                <td>{{ spec_value }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <h3 class="mt-4">{% trans "Additional Specifications" %}</h3>
          <table class="table table-striped mt-3">
            <tbody>
              {% for spec_name, spec_value in product.get_additional_specifications.items %}
              <tr>
                <td><strong>{{ spec_name }}</strong></td>
                <td>{{ spec_value }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
          <div class="row mt-4">
            <div class="col-md-7">
              <h4>{% trans "Customer Reviews" %}</h4>
              {% if reviews %}
                {% for review in reviews %}
                  <div class="d-flex mb-3 pb-3 border-bottom">
                    <div class="flex-shrink-0">
                      <img src="{{ review.user.userprofile.get_profile_picture_url }}" alt="{{ review.user.username }}" class="rounded-circle" width="50" height="50">
                    </div>
                    <div class="flex-grow-1 ms-3">
                      <strong>{{ review.user.username }}</strong>
                      <div class="text-warning">
                        {% for i in "12345" %}
                          <i class="bi bi-star{% if forloop.counter <= review.rating %}-fill{% endif %}"></i>
                        {% endfor %}
                      </div>
                      {% if review.review %}
                        <p class="mb-1">{{ review.review }}</p>
                      {% endif %}
                      {% if review.video %}
                        <div class="mt-2">
                          <video width="100%" style="max-width: 400px; border-radius: 8px;" controls>
                            <source src="{{ review.video.url }}" type="{{ review.video.content_type }}">
                            Your browser does not support the video tag.
                          </video>
                        </div>
                      {% endif %}
                      <small class="text-muted">{{ review.created_at|date:"F d, Y" }}</small>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <p>{% trans "No reviews yet. Be the first to review this product!" %}</p>
              {% endif %}
            </div>
            <div class="col-md-5">
              <h4>{% trans "Write a Review" %}</h4>
              {% if user.is_authenticated %}
                {% if user_has_reviewed_product %}
                  <div class="alert alert-info">{% trans "You have already submitted a review for this product." %}</div>
                {% else %}
                  <form action="{% url 'core:submit_product_review' product.id %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                      <label class="form-label d-block">{{ review_form.rating.label }}</label>
                      <div class="rating-stars">
                        <input type="radio" id="star5" name="rating" value="5" required /><label for="star5" title="5 stars">★</label>
                        <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 stars">★</label>
                        <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 stars">★</label>
                        <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 stars">★</label>
                        <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 star">★</label>
                      </div>
                      {{ review_form.rating.errors }}
                    </div>
                    {{ review_form.review|as_crispy_field }}
                    {{ review_form.video|as_crispy_field }}
                    <button type="submit" class="btn btn-primary">{% trans "Submit Review" %}</button>
                  </form>
                {% endif %}
              {% else %}
                <p>{% trans "You must be" %} <a href="{% url 'authapp:signin' %}?next={{ request.path }}">{% trans "logged in" %}</a> {% trans "to post a review." %}</p>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="qa" role="tabpanel" aria-labelledby="qa-tab">
            <div class="row mt-4">
                <div class="col-md-10 mx-auto">
                    <h4 class="mb-4">{% trans "Questions & Answers" %}</h4>

                    {# Ask a Question Form #}
                    {% if user.is_authenticated %}
                    <div class="card mb-4 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">{% trans "Have a question?" %}</h5>
                            <form action="{% url 'core:add_product_question' product.id %}" method="post">
                                {% csrf_token %}
                                {{ question_form|crispy }}
                                <button type="submit" class="btn btn-primary mt-2">{% trans "Submit Question" %}</button>
                            </form>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <a href="{% url 'authapp:signin' %}?next={{ request.path }}">{% trans "Log in" %}</a> {% trans "to ask a question or post an answer." %}
                    </div>
                    {% endif %}

                    {# List of Questions and Answers #}
                    {% for question in questions %}
                    <div class="d-flex mb-4">
                        <div class="flex-shrink-0">
                            <img src="{{ question.user.userprofile.get_profile_picture_url }}" alt="{{ question.user.username }}" class="rounded-circle" width="50" height="50" style="object-fit: cover;">
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <div class="fw-bold">{{ question.user.get_full_name|default:question.user.username }}</div>
                            <p class="mb-1">{{ question.text|linebreaksbr }}</p>
                            <small class="text-muted">{{ question.created_at|naturaltime }}</small>

                            {# Answers to this question #}
                            {% for answer in question.answers.all %}
                            <div class="d-flex mt-3">
                                <div class="flex-shrink-0">
                                    <img src="{{ answer.user.userprofile.get_profile_picture_url }}" alt="{{ answer.user.username }}" class="rounded-circle" width="40" height="40" style="object-fit: cover;">
                                </div>
                                <div class="ms-3 flex-grow-1">
                                    <div class="fw-bold">
                                        {{ answer.user.get_full_name|default:answer.user.username }}
                                        {% if product.vendor and answer.user == product.vendor.user %}
                                            <span class="badge bg-success ms-1">{% trans "Vendor" %}</span>
                                        {% endif %}
                                    </div>
                                    <p class="mb-1">{{ answer.text|linebreaksbr }}</p>
                                    <small class="text-muted">{{ answer.created_at|naturaltime }}</small>
                                </div>
                            </div>
                            {% endfor %}

                            {# Answer this question form #}
                            {% if user.is_authenticated %}
                            <div class="mt-3">
                                <form action="{% url 'core:add_product_answer' question.id %}" method="post" class="d-flex gap-2">
                                    {% csrf_token %}
                                    <div class="flex-grow-1">{{ answer_form.text }}</div>
                                    <button type="submit" class="btn btn-sm btn-outline-primary">{% trans "Post Answer" %}</button>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">{% trans "No questions have been asked about this product yet. Be the first!" %}</p>
                    {% endfor %}
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>

  {% comment %} This section displays the interactive 3D/AR viewer if a 3D model is available. {% endcomment %}
  {% if product.three_d_model %}
  <div class="product-3d-viewer my-4 p-3 border rounded shadow-sm">
    <h4 class="mb-3">{% translate "Interactive 3D & AR View" %}</h4>
    {# Load the <model-viewer> component. Using version 3.5.0 for latest features. #}
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
    
    <model-viewer 
        src="{{ product.three_d_model.url }}"
        {% if product.ar_model %}ios-src="{{ product.ar_model.url }}"{% endif %}
        alt="A 3D model of {{ product.name }}" 
        auto-rotate camera-controls ar ar-modes="webxr scene-viewer quick-look" 
        shadow-intensity="1" environment-image="neutral" exposure="1" 
        style="width: 100%; height: 450px; background-color: #f8f9fa; border-radius: 8px;">
      <div class="progress-bar hide" slot="progress-bar">
        <div class="update-bar"></div>
      </div>
      <button slot="ar-button" id="ar-button" class="btn btn-primary mt-2">
          <i class="fas fa-cube me-2"></i> {% translate "View in your space" %}
      </button>
    </model-viewer>
    <p class="text-muted small mt-2">{% translate "Click and drag to rotate. Scroll to zoom. Try AR on compatible devices!" %}</p>
  </div>
  {% endif %}

  {% if related_products %}
  <div class="row mt-5">
    <div class="col">
      <h2>{% trans "Related Products" %}</h2>
      <div class="row row-cols-1 row-cols-md-3 g-4">
        {% for related_product in related_products %}
        <div class="col">
          <div class="card h-100">
            {% with related_image_obj=related_product.image %}
              {% if related_product.image_enhanced %}
              <img src="{{ related_product.image_enhanced.url }}" class="card-img-top" alt="{{ related_product.name }}">
              {% elif related_image_obj and related_image_obj.image %}
              <img src="{{ related_image_obj.image.url }}" class="card-img-top" alt="{{ related_product.name }}">
              {% else %}
              <img src="{% static 'assets/img/placeholder.png' %}" class="card-img-top" alt="{{ related_product.name }}">
              {% endif %}
            {% endwith %}
            <div class="card-body">
              <h5 class="card-title">{{ related_product.name }}</h5>
              <p class="card-text">GH₵{{ related_product.price }}</p>
              <a href="{{ related_product.get_absolute_url }}" class="btn btn-primary">{% trans "View Details" %}</a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock content %}

{% block extra_js %}
{{ block.super }} {# This inherits scripts from base.html, fixing Bootstrap tabs #}

<script src="https://cdnjs.cloudflare.com/ajax/libs/drift-zoom/1.3.1/Drift.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const mediaDisplayArea = document.getElementById('media-display-area');
    const zoomPane = document.querySelector('.detail-pane');
    const galleryContainer = document.querySelector('.thumbnail-gallery');
    let drift; // This will hold the active Drift instance.

    function updateMainMedia(type, url) {
        // Clean up completely by removing old elements.
        mediaDisplayArea.innerHTML = '';
        // The old drift instance is now gone along with its trigger element.

        if (type === 'image') {
            const img = document.createElement('img');
            img.id = 'product-image'; // The trigger needs an ID or class.
            img.className = 'drift-trigger img-fluid rounded';
            img.src = url;
            img.dataset.zoom = url;
            img.style.maxHeight = '450px';
            mediaDisplayArea.appendChild(img);

            // Initialize a new Drift instance.
            drift = new Drift(img, {
                paneContainer: zoomPane,
                inlinePane: false,
                hoverBoundingBox: true,
                zoomFactor: 3
            });
        } else if (type === 'video') {
            const video = document.createElement('video');
            video.className = 'img-fluid rounded';
            video.src = url;
            video.controls = true;
            video.autoplay = true;
            video.muted = true;
            video.style.maxHeight = '450px';
            mediaDisplayArea.appendChild(video);
        }
    }

    // Use event delegation for the gallery
    if (galleryContainer) {
        galleryContainer.addEventListener('click', function(event) {
            const thumbnailWrapper = event.target.closest('.thumbnail-item-wrapper');
            if (!thumbnailWrapper) return; // Exit if click was not on a thumbnail

            const thumbnailImg = thumbnailWrapper.querySelector('.thumbnail-item');
            if (!thumbnailImg) return;

            // Update active state
            galleryContainer.querySelectorAll('.thumbnail-item').forEach(t => t.classList.remove('active'));
            thumbnailImg.classList.add('active');

            // Get data and update display
            const mediaType = thumbnailImg.dataset.mediaType;
            const largeSrc = thumbnailImg.dataset.largeSrc;
            updateMainMedia(mediaType, largeSrc);
        });
    }

    // Initial load
    const firstThumbnail = document.querySelector('.thumbnail-item');
    if (firstThumbnail) {
        const initialType = firstThumbnail.dataset.mediaType;
        const initialSrc = firstThumbnail.dataset.largeSrc;
        updateMainMedia(initialType, initialSrc);
    }

    // AJAX for AI Description Enhancement
    const enhanceForm = document.getElementById('enhance-description-form');
    if (enhanceForm) {
      enhanceForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const button = document.getElementById('enhance-description-btn');
        const originalButtonHtml = button.innerHTML;
        const descriptionP = document.getElementById('product-description');

        // Show loading state
        button.disabled = true;
        button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> {% trans "Enhancing..." %}`;

        fetch(this.action, {
          method: 'POST',
          body: new FormData(this),
          headers: {
            'X-CSRFToken': this.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest' // Standard header for AJAX
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            descriptionP.textContent = data.new_description;
            // You could add a small success message here if you want
          } else {
            alert('Error: ' + data.error); // Simple alert for error
          }
        })
        .catch(error => {
          console.error('Error enhancing description:', error);
          alert('An unexpected error occurred.');
        })
        .finally(() => {
          // Restore button state
          button.disabled = false;
          button.innerHTML = originalButtonHtml;
        });
      });
    }
  });
</script>
{% endblock extra_js %}
