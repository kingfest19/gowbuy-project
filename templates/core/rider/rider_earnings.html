{% extends "base.html" %}
{% load static i18n %}
{% load humanize %} <!-- For better number formatting, e.g., with commas -->

{% block title %}{{ page_title }} | {% trans "Rider Dashboard" %}{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <style>
        .earnings-container {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }
        .earnings-container h2.page-main-title {
            color: #007bff;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        .summary-card {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .summary-card h5 {
            margin-bottom: 5px;
            color: #495057;
        }
        .summary-card .amount {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .amount.positive { color: #28a745; } /* Green for positive balance */
        .amount.neutral { color: #6c757d; } /* Grey for zero */
        .amount.negative { color: #dc3545; } /* Red for negative (shouldn't happen here) */
    </style>
{% endblock extra_css %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row">
        {% include "core/rider/rider_dashboard_sidebar_snippet.html" %}
        <div class="col-md-9">
            <div class="earnings-container">
                <h2 class="page-main-title">{{ page_title }}</h2>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="summary-card text-center">
                            <h5>{% trans "Total Earned" %}</h5>
                            <p class="amount positive">{{ settings.DEFAULT_CURRENCY_SYMBOL|default:"GH₵" }}{{ total_earned|floatformat:2|intcomma }}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="summary-card text-center">
                            <h5>{% trans "Total Paid Out" %}</h5>
                            <p class="amount neutral">{{ settings.DEFAULT_CURRENCY_SYMBOL|default:"GH₵" }}{{ total_paid_out|floatformat:2|intcomma }}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="summary-card text-center">
                            <h5>{% trans "Available Balance" %}</h5>
                            <p class="amount {% if current_balance > 0 %}positive{% elif current_balance == 0 %}neutral{% else %}negative{% endif %}">
                                {{ settings.DEFAULT_CURRENCY_SYMBOL|default:"GH₵" }}{{ current_balance|floatformat:2|intcomma }}
                            </p>
                        </div>
                    </div>
                </div>

                {% if payout_form %}
                    <div class="card my-4">
                        <div class="card-header">
                            <h5>{% trans "Request Payout" %}</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{% url 'core:rider_request_payout' %}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="{{ payout_form.amount_requested.id_for_label }}" class="form-label">{{ payout_form.amount_requested.label }}</label>
                                    {{ payout_form.amount_requested }}
                                    {% if payout_form.amount_requested.help_text %}
                                        <div class="form-text">{{ payout_form.amount_requested.help_text }}</div>
                                    {% endif %}
                                    {% for error in payout_form.amount_requested.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-wallet2 me-1"></i> {% trans "Submit Payout Request" %}
                                </button>
                            </form>
                        </div>
                    </div>
                {% elif current_balance <= 0 %}
                    <div class="alert alert-info" role="alert">
                        {% trans "You do not have an available balance to request a payout." %}
                    </div>
                {% else %} {# This case implies a pending request exists if payout_form is None and balance > 0 #}
                    <div class="alert alert-warning" role="alert">
                        {% trans "You currently have a payout request pending. Please wait for it to be processed before submitting a new one." %}
                    </div>
                {% endif %}

                <h4>{% trans "Earnings History (Completed Deliveries)" %}</h4>
                {% if completed_tasks %}
                    <div class="table-responsive mt-3">
                        <table class="table table-hover table-striped">
                            <thead class="table-light">
                                <tr>
                                    <th>{% trans "Date Delivered" %}</th>
                                    <th>{% trans "Order ID" %}</th>
                                    <th>{% trans "Task ID" %}</th>
                                    <th class="text-end">{% trans "Delivery Fee (Task)" %}</th>
                                    <th class="text-end">{% trans "Your Earning" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in completed_tasks %}
                                <tr>
                                    <td>{{ task.actual_delivery_time|date:"Y-m-d H:i"|default:task.updated_at|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        {% if task.order %}
                                            <a href="{% url 'core:order_detail' task.order.order_id %}">#{{ task.order.order_id }}</a>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'core:rider_task_detail' task.task_id %}">{{ task.task_id|truncatechars:15 }}</a>
                                    </td>
                                    <td class="text-end">{{ settings.DEFAULT_CURRENCY_SYMBOL|default:"GH₵" }}{{ task.delivery_fee|floatformat:2|intcomma }}</td>
                                    <td class="text-end fw-bold">{{ settings.DEFAULT_CURRENCY_SYMBOL|default:"GH₵" }}{{ task.rider_earning|floatformat:2|intcomma }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if is_paginated %}
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}
                                    <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">{% trans "Previous" %}</a></li>
                                {% else %}
                                    <li class="page-item disabled"><span class="page-link">{% trans "Previous" %}</span></li>
                                {% endif %}

                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                        <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                                    {% endif %}
                                {% endfor %}

                                {% if page_obj.has_next %}
                                    <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">{% trans "Next" %}</a></li>
                                {% else %}
                                    <li class="page-item disabled"><span class="page-link">{% trans "Next" %}</span></li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% endif %}

                {% else %}
                    <div class="alert alert-info mt-3">
                        <p>{% trans "You have no completed deliveries with earnings yet." %}</p>
                    </div>
                {% endif %}

                <!-- Payout History Section -->
                <h4 class="mt-5">{% trans "Payout History" %}</h4>
                {% if payout_history %}
                    <div class="table-responsive mt-3">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>{% trans "Date Processed" %}</th>
                                    <th>{% trans "Amount" %}</th>
                                    <th>{% trans "Transaction ID" %}</th>
                                    <th>{% trans "Description" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payout_tx in payout_history %}
                                <tr>
                                    <td>{{ payout_tx.created_at|date:"Y-m-d H:i" }}</td>
                                    <td>{{ settings.DEFAULT_CURRENCY_SYMBOL|default:"GH₵" }}{{ payout_tx.amount|floatformat:2|intcomma }}</td>
                                    <td>{{ payout_tx.gateway_transaction_id|default:"N/A" }}</td>
                                    <td>{{ payout_tx.description|truncatewords:10|default:"Payout processed" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info mt-3">
                        <p>{% trans "You have no completed payouts yet." %}</p>
                    </div>
                {% endif %}
                <!-- End Payout History Section -->

            </div>
        </div>
    </div>
</div>
{% endblock content %}
