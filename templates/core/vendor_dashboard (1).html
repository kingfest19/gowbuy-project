{% extends "base.html" %}
{% load static %}
{% load notification_tags %} {# Load your new notification tags #}
{% load i18n humanize %} {# Added humanize for intcomma #}

{% block title %}{% trans "Vendor Dashboard" %} - {{ vendor.name }}{% endblock title %}

{% block extra_css %}
    {# Add specific dashboard CSS if needed later #}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        /*
         IMPORTANT: For the sidebar to be sticky and the main navigation (from base.html)
         to stay on top, your main navigation elements in base.html (e.g., <nav> and .nav-bottom)
         need to have `position: sticky; top: ...; z-index: ...;` applied, typically in your
         global CSS (like assets/css/home.css or core/css/custom_styles.css).

         Example for base.html's header (add to your global CSS):
         nav { // The main top nav bar from base.html
             position: sticky;
             top: 0;
             z-index: 1030; // High z-index
             background-color: white; // Or your nav's background
         }
         .nav-bottom { // The secondary nav bar from base.html
             position: sticky;
             top: 70px; // Adjust based on the height of your top nav
             z-index: 1029; // Slightly lower than main nav
             background-color: #f8f9fa; // Or your nav-bottom's background
         }
         main {
             padding-top: 120px; // Adjust to prevent content from going under sticky headers
                                // This should be roughly height_of_top_nav + height_of_nav_bottom
         }
        */

        .dashboard-sidebar {
            background-color: #f8f9fa;
            padding: 1.0rem; /* Adjusted padding for the whole sidebar block */
            border-radius: 0.375rem;
            position: sticky; 
            /* IMPORTANT: Adjust this 'top' value based on the total height of your sticky main site navigation from base.html */
            top: 120px; /* Example: if main nav is 70px and nav-bottom is 50px, total is 120px */
            /* Adjust 120px to match the 'top' value above */
            overflow-y: auto; /* Allows sidebar content to scroll if it's too long */

        }
        .dashboard-sidebar .nav-link {
            color: #495057;
            padding: 0.5rem 1rem; /* Reduced padding for individual links */
            margin-bottom: 0.1rem; /* Reduced margin for individual links */
        }
        .dashboard-sidebar .nav-link.active {
            background-color: var(--bs-primary);
            color: white;
            font-weight: 500;
        }
        .dashboard-sidebar .nav-link:hover {
            background-color: #e9ecef;
        }
        .status-badge {
            font-size: 0.9em;
        }
        .checklist-item {
            border-bottom: 1px solid #eee;
            padding: 1rem 0;
        }
        .checklist-item:last-child {
            border-bottom: none; /* Remove border from last item */
        }
        .card-text.fs-4 { /* Ensure card numbers are prominent */
            margin-bottom: 0.5rem;
        }
        .list-group-item h6 {
            margin-bottom: 0.25rem; /* Adjust spacing in lists */
        }
        /* --- START: Dashboard Overview Card Styling --- */
        .dashboard-overview-card .card-body .card-title,
        .dashboard-overview-card .card-body .card-text,
        .dashboard-overview-card .card-body small {
            color: #212529 !important; /* Ensure text is black */
        }
        .dashboard-overview-card .card-body .text-muted {
            color: #6c757d !important; /* Ensure muted text is standard grey */
        }
        .dashboard-overview-card .card { /* This style was already good */
             border: 1px solid #dee2e6; /* Add a subtle border */
             box-shadow: 0 .125rem .25rem rgba(0,0,0,.075); /* Add a slight shadow */
        }

        /* --- START: Vendor Dashboard Card Colors --- */
        .vendor-card-sales { background-color:rgb(115, 160, 139); color: #fff; } /* Green */
        .vendor-card-orders { background-color:rgb(147, 191, 200); color: #fff; } /* Cyan */
        .vendor-card-products { background-color:rgb(178, 166, 199); color: #fff; } /* Purple */
        .vendor-card-low-stock { background-color:rgb(210, 197, 157); color: #212529; } /* Yellow (dark text) */

        /* Adjust text colors for contrast on colored backgrounds */
        .vendor-card-sales .card-title, .vendor-card-sales .card-text, .vendor-card-sales small,
        .vendor-card-orders .card-title, .vendor-card-orders .card-text, .vendor-card-orders small,
        .vendor-card-products .card-title, .vendor-card-products .card-text, .vendor-card-products small {
            color: rgba(255, 255, 255, 0.9) !important;
        }
        .vendor-card-low-stock .card-title, .vendor-card-low-stock .card-text, .vendor-card-low-stock small {
            color: #212529 !important; /* Dark text for yellow background */
        }
        .vendor-card-low-stock .btn-outline-warning { /* Make button more visible on yellow */
            border-color: #493805; color: #493805;
        }
        /* --- END: Dashboard Overview Card Styling --- */
    </style>
{% endblock extra_css %}

{% block content %}
<div class="container-fluid my-4"> {# Use container-fluid for wider layout #}
    <div class="row">
        {# Sidebar Navigation #}
        <div class="col-md-3">
            <nav class="nav flex-column dashboard-sidebar mb-4 mb-md-0"> {# Ensured flex-column for vertical stacking #}
                <h5 class="mb-2">{% trans "Dashboard Menu" %}</h5>
                <a class="nav-link active" href="{% url 'core:vendor_dashboard' %}">üìä {% trans "Overview" %}</a>
                <a class="nav-link" href="{% url 'core:vendor_products' %}">üì¶ {% trans "Products" %}</a>
                <a class="nav-link" href="{% url 'core:vendor_orders' %}">üßæ {% trans "Orders" %}</a>
                <a class="nav-link" href="{% url 'core:vendor_reports' %}">üìà {% trans "Reports" %}</a>
                <a class="nav-link" href="{% url 'core:vendor_profile_edit' %}">‚úèÔ∏è {% trans "Edit Profile" %}</a>
                <a class="nav-link" href="{% url 'core:vendor_shipping_settings' %}">üöö {% trans "Shipping" %}</a>
                <a class="nav-link" href="{% url 'core:vendor_payment_settings' %}">üí≥ {% trans "Payments" %}</a>
                <a class="nav-link" href="{% url 'core:vendor_payout_requests' %}">üí∞ {% trans "Payouts" %}</a>
                <a class="nav-link" href="{% url 'core:vendor_verification_multistep' %}">‚úÖ {% trans "Verification" %}</a>
                <a class="nav-link" href="{% url 'core:vendor_promotions' %}">üè∑Ô∏è {% trans "Promotions" %}</a>
                {# Removed hr as it might look odd in a horizontal layout #}
                <a class="nav-link" href="{% url 'core:vendor_ads' %}">üì¢ {% trans "Ad Campaigns" %}</a>
                <a class="nav-link" href="{% url 'core:vendor_reviews' %}">‚≠ê {% trans "Reviews" %}</a>
                <a class="nav-link position-relative" href="{% url 'core:vendor_notification_list' %}">
                    üîî {% trans "Notifications" %}
                    {% if notification_count > 0 %}
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.7em; margin-left: -10px; margin-top: 5px;">
                            {{ notification_count }}
                            <span class="visually-hidden">unread notifications</span>
                        </span>
                    {% endif %}
                </a>
            </nav>
        </div>

        {# Main Content Area #}
        <div class="col-md-9">
            <h1 class="mb-4">{% trans "Welcome," %} {{ vendor.name }}!</h1>

            {% include 'partials/_messages.html' %} {# Display messages at the top #}

            <!-- Start: Report Summary Section -->
            <h2 class="h4 mb-3">Store Overview</h2>
            <div class="row g-3 mb-4">
                <div class="col-md-6 col-lg-3">
                    <div class="card h-100 dashboard-overview-card vendor-card-sales">
                        <div class="card-body text-center">
                            <h5 class="card-title"><i class="bi bi-currency-dollar text-success me-2"></i>Total Sales</h5>
                            <p class="card-text fs-4 fw-bold">${{ total_sales|floatformat:2|intcomma }}</p>
                            {# Note: Consider filtering sales by completed orders in the view for accuracy #}
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card h-100 dashboard-overview-card vendor-card-orders">
                        <div class="card-body text-center">
                            <h5 class="card-title"><i class="bi bi-box-seam text-info me-2"></i>Total Orders</h5>
                            <p class="card-text fs-4 fw-bold">{{ total_orders_count|intcomma }}</p>
                            <small class="text-muted">Orders containing your products</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card h-100 dashboard-overview-card vendor-card-products">
                        <div class="card-body text-center">
                            <h5 class="card-title"><i class="bi bi-tags text-primary me-2"></i>Active Products</h5>
                            <p class="card-text fs-4 fw-bold">{{ active_products_count|intcomma }}</p>
                            <small class="text-muted">/ {{ total_products_count|intcomma }} total</small>
                        </div>
                    </div>
                </div>
                 <div class="col-md-6 col-lg-3">
                    <div class="card h-100 dashboard-overview-card vendor-card-low-stock">
                        <div class="card-body text-center">
                            <h5 class="card-title"><i class="bi bi-graph-down text-warning me-2"></i>Low Stock</h5>
                            <p class="card-text fs-4 fw-bold">{{ low_stock_products.count }}</p>
                             {# Link the button to the filtered product list page #}
                             {% if low_stock_products %}
                                <a href="{% url 'core:vendor_products' %}?stock_status=low" class="btn btn-sm btn-outline-warning mt-1">View List</a> {# Kept outline for yellow #}
                            {% else %}
                                <small class="text-muted">No items low on stock</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <!-- End: Report Summary Section -->

            {# --- START: Onboarding Checklist --- #}
            <div class="mb-4 p-3 border rounded bg-light"> {# Added padding, border, background #}
                <h5 class="mb-3">{% trans "Shop Setup Checklist" %}</h5>
                {% if not vendor.is_approved and vendor.verification_status != Vendor.VERIFICATION_STATUS_VERIFIED %}
                    <div class="alert alert-warning small p-2 mb-3"> {# Adjusted padding/margin #}
                        {% blocktrans %}Please complete all required sections, including submitting your verification documents. Your shop will go live after successful verification by our team.{% endblocktrans %}
                    </div>
                {% elif vendor.verification_status == Vendor.VERIFICATION_STATUS_PENDING_REVIEW %}
                    <div class="alert alert-info small p-2 mb-3">
                        {% trans "Your verification documents have been submitted and are pending review by our team." %}
                    </div>
                {% elif vendor.verification_status == Vendor.VERIFICATION_STATUS_NEEDS_RESUBMISSION or vendor.verification_status == Vendor.VERIFICATION_STATUS_REJECTED %}
                    {% url 'core:vendor_verification_multistep' as verification_url %}
                    <div class="alert alert-danger small p-2 mb-3">
                        {% blocktrans %}There was an issue with your verification. Please check your notifications or contact support, then <a href="{{ verification_url }}">resubmit your information</a>.{% endblocktrans %}
                    </div>
                {% elif vendor.is_approved %}
                     <div class="alert alert-success small p-2 mb-3">
                        {% trans "Your shop is live!" %}
                    </div>
                {% endif %}

                <div class="checklist-item d-flex justify-content-between align-items-center">
                    <span><a href="{% url 'core:vendor_profile_edit' %}">{% trans "Shop Information" %}</a></span>
                    <span class="badge status-badge {% if shop_info_complete %}bg-success{% else %}bg-warning text-dark{% endif %}">{% if shop_info_complete %}{% trans "COMPLETED" %}{% else %}{% trans "PENDING" %}{% endif %}</span>
                </div>
                <div class="checklist-item d-flex justify-content-between align-items-center">
                    <span><a href="{% url 'core:vendor_verification_multistep' %}">{% trans "Business/Verification Information" %}</a></span>
                    <span class="badge status-badge 
                        {% if vendor.verification_status == Vendor.VERIFICATION_STATUS_VERIFIED %}bg-success
                        {% elif vendor.verification_status == Vendor.VERIFICATION_STATUS_PENDING_REVIEW %}bg-info text-dark
                        {% elif vendor.verification_status == Vendor.VERIFICATION_STATUS_REJECTED or vendor.verification_status == Vendor.VERIFICATION_STATUS_NEEDS_RESUBMISSION %}bg-danger
                        {% else %}bg-warning text-dark{% endif %}">
                        {{ vendor.get_verification_status_display }}
                    </span>
                </div>
                <div class="checklist-item d-flex justify-content-between align-items-center">
                    <span><a href="{% url 'core:vendor_shipping_settings' %}">{% trans "Shipping Information" %}</a></span>
                    <span class="badge status-badge {% if shipping_info_complete %}bg-success{% else %}bg-warning text-dark{% endif %}">{% if shipping_info_complete %}{% trans "COMPLETED" %}{% else %}{% trans "PENDING" %}{% endif %}</span>
                </div>
                <div class="checklist-item d-flex justify-content-between align-items-center">
                    <span><a href="{% url 'core:vendor_payment_settings' %}">{% trans "Payment Information" %}</a></span>
                    <span class="badge status-badge {% if payment_info_complete %}bg-success{% else %}bg-warning text-dark{% endif %}">{% if payment_info_complete %}{% trans "COMPLETED" %}{% else %}{% trans "PENDING" %}{% endif %}</span>
                </div>
                <div class="checklist-item d-flex justify-content-between align-items-center">
                    <span><a href="{% url 'core:edit_vendor_additional_info' %}">{% trans "Additional Information" %}</a></span> {# <<< Updated link #}
                    <span class="badge status-badge {% if additional_info_complete %}bg-success{% else %}bg-warning text-dark{% endif %}">{% if additional_info_complete %}{% trans "COMPLETED" %}{% else %}{% trans "PENDING" %}{% endif %}</span>
                </div>
            </div>
            {# --- END: Onboarding Checklist --- #}

            <!-- Start: Recent Orders and Low Stock Lists -->
            <div class="row g-4 mt-4">
                <!-- Recent Orders -->
                <div class="col-lg-7">
                    <h2 class="h4 mb-3"><i class="bi bi-receipt me-2"></i>Recent Orders</h2>
                    {% if recent_orders %}
                    <div class="list-group">
                        {% for order in recent_orders %}
                        {# Link to the standard order detail for now, consider a vendor-specific one later #}
                        <a href="{% url 'core:order_detail' order.order_id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Order #{{ order.order_id }}</h6>
                                <small class="text-muted">Placed on: {{ order.created_at|date:"M d, Y H:i" }}</small>
                                {% if order.user %}<small class="d-block">Customer: {{ order.user.username }}</small>{% endif %}
                            </div>
                            {# Dynamically set badge color based on status text #}
                            <span class="badge bg-{% if order.status == 'pending' %}warning text-dark{% elif order.status == 'processing' %}info text-dark{% elif order.status == 'shipped' %}primary{% elif order.status == 'delivered' %}success{% elif order.status == 'cancelled' or order.status == 'refunded' %}danger{% else %}secondary{% endif %} rounded-pill">{{ order.get_status_display }}</span>
                        </a>
                        {% endfor %}
                    </div>
                    <div class="mt-2">
                         {# Ensure you have a 'vendor_order_list' URL pattern defined #}
                         <a href="{% url 'core:vendor_orders' %}" class="btn btn-sm btn-outline-secondary">View All Orders</a>
                    </div>
                    {% else %}
                    <div class="alert alert-light" role="alert">
                        No recent orders found.
                    </div>
                    {% endif %}
                </div>

                <!-- Low Stock Products -->
                <div class="col-lg-5" id="low-stock-list">
                    <h2 class="h4 mb-3"><i class="bi bi-box-fill text-danger me-2"></i>Low Stock Items (<= 5)</h2>
                    {% if low_stock_products %}
                    <div class="list-group">
                        {% for product in low_stock_products %}
                        <a href="{% url 'core:vendor_product_edit' product.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ product.name }}</h6>
                                <small class="text-muted">SKU: {{ product.sku|default:"N/A" }}</small> {# Assuming you might add an SKU field later #}
                            </div>
                            <span class="badge bg-danger rounded-pill">{{ product.stock }} left</span>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-light" role="alert">
                        No products are currently low on stock.
                    </div>
                    {% endif %}
                </div>
            </div>
            <!-- End: Recent Orders and Low Stock Lists -->

        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
    {{ block.super }}
    {# Add specific dashboard JS if needed #}
{% endblock extra_js %}
