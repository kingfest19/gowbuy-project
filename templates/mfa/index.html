{% extends "core/user_dashboard_base.html" %}
{% load i18n allauth %}

{% block page_styles %}
<style>
    .mfa-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border: 1px solid var(--bs-border-color);
        border-radius: .375rem;
        background-color: var(--bs-body-bg);
        transition: box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
    }
    .mfa-section:not(:last-child) {
        margin-bottom: 1.5rem;
    }
    .mfa-section:hover {
        border-color: var(--bs-primary);
        box-shadow: 0 .125rem .5rem rgba(0,0,0,.075);
    }
    .mfa-section-content h3 {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
    }
    .mfa-section-content p {
        margin-bottom: 0;
        color: var(--bs-secondary-color);
    }
    .mfa-section-actions {
        flex-shrink: 0; /* Prevent action buttons from wrapping */
        margin-left: 1.5rem;
    }
</style>
{% endblock page_styles %}

{% block dashboard_content %}
    <h2 class="mb-4">{% trans "Two-Factor Authentication" %}</h2>
    <p class="text-muted mb-4">{% trans "Strengthen your account's security by enabling two-factor authentication (2FA)." %}</p>

    {% if "totp" in MFA_SUPPORTED_TYPES %}
    <div class="mfa-section">
        <div class="mfa-section-content">
            <h3><i class="fas fa-mobile-alt me-2 text-primary"></i>{% translate "Authenticator App" %}</h3>
            {% if authenticators.totp %}
                <p>{% translate "Authentication using an authenticator app is active." %}</p>
            {% else %}
                <p>{% translate "Use an authenticator app for a secure way to generate login codes." %}</p>
            {% endif %}
        </div>
        <div class="mfa-section-actions">
            {% url 'mfa_deactivate_totp' as deactivate_url %}
            {% url 'mfa_activate_totp' as activate_url %}
            {% if authenticators.totp %}
                <a href="{{ deactivate_url }}" class="btn btn-danger">{% translate "Deactivate" %}</a>
            {% else %}
                <a href="{{ activate_url }}" class="btn btn-primary">{% translate "Activate" %}</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if "webauthn" in MFA_SUPPORTED_TYPES %}
    <div class="mfa-section">
        <div class="mfa-section-content">
            <h3><i class="fas fa-key me-2 text-primary"></i>{% translate "Security Keys" %}</h3>
            {% if authenticators.webauthn|length %}
                <p>{% blocktranslate count count=authenticators.webauthn|length %}You have {{ count }} security key added.{% plural %}You have {{ count }} security keys added.{% endblocktranslate %}</p>
            {% else %}
                <p>{% translate "Add a physical security key or use a Passkey for the highest level of security." %}</p>
            {% endif %}
        </div>
        <div class="mfa-section-actions">
            {% if authenticators.webauthn|length %}
                {% url 'mfa_list_webauthn' as webauthn_list_url %}
                <a href="{{ webauthn_list_url }}" class="btn btn-secondary">{% translate "Manage" %}</a>
            {% else %}
                {% url 'mfa_add_webauthn' as webauthn_add_url %}
                <a href="{{ webauthn_add_url }}" class="btn btn-primary">{% translate "Add Security Key" %}</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if "recovery_codes" in MFA_SUPPORTED_TYPES %}
    {% with total_count=authenticators.recovery_codes.generate_codes|length unused_count=authenticators.recovery_codes.get_unused_codes|length %}
    <div class="mfa-section">
        <div class="mfa-section-content">
            <h3><i class="fas fa-file-alt me-2 text-primary"></i>{% translate "Recovery Codes" %}</h3>
            {% if authenticators.recovery_codes %}
                <p>{% blocktranslate count unused_count=unused_count %}{{ unused_count }} out of {{ total_count }} recovery codes available.{% plural %}{{ unused_count }} out of {{ total_count }} recovery codes available.{% endblocktranslate %}</p>
            {% else %}
                <p>{% translate "Generate and save recovery codes to access your account if you lose your primary 2FA device." %}</p>
            {% endif %}
        </div>
        {% if is_mfa_enabled %}
        <div class="mfa-section-actions d-flex gap-2">
            {% if authenticators.recovery_codes and unused_count > 0 %}
                <a href="{% url 'mfa_view_recovery_codes' %}" class="btn btn-primary">{% translate "View Codes" %}</a>
                <a href="{% url 'mfa_download_recovery_codes' %}" class="btn btn-secondary">{% translate "Download" %}</a>
            {% endif %}
            <a href="{% url 'mfa_generate_recovery_codes' %}" class="btn btn-outline-secondary">{% translate "Generate New Codes" %}</a>
        </div>
        {% endif %}
    </div>
    {% endwith %}
    {% endif %}

{% endblock dashboard_content %}
